<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/umd.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="icon" href="https://thamanoonni.github.io/ta/favicon.ico" type="image/x-icon">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  
  <meta name="theme-color" content="#0d6efd">
  
  <style>
    body { font-family: 'Kanit', sans-serif; background-color: #f4f6f9; }
    .card { border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .hidden { display: none !important; }
    .btn-primary { background-color: #0d6efd; border: none; }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex; justify-content: center; align-items: center;
        z-index: 3000;
    }
    .modal-content-box {
        background: white; width: 90%; max-width: 400px;
        border-radius: 15px; padding: 20px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }
    .token-debug {
        position: fixed; bottom: 2px; left: 2px; font-size: 8px; color: #ccc; z-index: 9999;
    }

    /* Map & Clock Styles */
    #liveMap { height: 250px; width: 100%; border-radius: 10px; z-index: 1; margin-bottom: 10px; border: 1px solid #ddd; }
    #liveClock { font-size: 3.5rem; font-weight: 600; color: #333; line-height: 1; letter-spacing: 2px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
    .status-badge-box { background: white; border: 1px solid #ddd; border-radius: 20px; padding: 5px 15px; display: inline-block; margin-bottom: 10px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

    /* Portal Grid Styles */
    .app-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 15px;
        padding: 10px;
    }
    .app-card {
        background: white;
        border-radius: 15px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid #eee;
    }
    .app-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .app-icon {
        width: 50px;
        height: 50px;
        object-fit: contain;
        margin-bottom: 8px;
    }
    .app-name {
        font-size: 0.85rem;
        font-weight: 600;
        color: #333;
        line-height: 1.2;
    }
    /* ‡∏õ‡∏∏‡πà‡∏° Back to Home ‡∏ö‡∏ô Header */
    .btn-home {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    
    html, body {
        height: 100%;           
        margin: 0;              
        padding: 0;
        overflow: hidden;       
    }
    
    .full-height-container {
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* --- Styles ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dashboard --- */
    .chart-container-main { position: relative; height: 250px; width: 100%; display: flex; justify-content: center; }
    .card-sub { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 10px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .center-text-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; }
    .center-value { font-size: 2rem; font-weight: bold; color: #0d6efd; line-height: 1; }
    .center-label { font-size: 0.8rem; color: #6c757d; }

    /* --- ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á USERS (Mobile Optimized) --- */
    .card-full-width {
        padding: 0 !important;
        overflow: hidden; 
        border-radius: 12px;
    }
    
    .table-wrapper {
        height: 75vh;      
        overflow-y: auto;  
        overflow-x: auto;  
        background: white;
    }

    .table-mobile {
        font-size: 0.85rem; 
        width: 100%;
        margin-bottom: 0;
        table-layout: fixed; 
    }

    .sticky-header th {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #f1f3f5;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        padding: 12px 5px;
        font-size: 0.8rem;
        white-space: nowrap;
    }

    .table-mobile td {
        padding: 8px 5px;
        vertical-align: middle;
        word-wrap: break-word; 
        white-space: normal;   
    }
    
    .col-img { width: 50px; text-align: center; }
    .col-info { width: auto; } 
    .col-status { width: 65px; text-align: center; }
    .col-action { width: 50px; text-align: center; }

  </style>
</head>
<body>

<div class="container p-0" style="max-width: 500px; height: 100%; position: relative;">
  
  <div id="inAppAlert" class="alert alert-danger hidden text-center fade-in">
      <h4 class="fw-bold"><i class="bi bi-exclamation-triangle"></i> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h4>
      <p class="mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE ‡∏´‡∏£‡∏∑‡∏≠ Facebook</p>
      <p class="small text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <b>‡∏à‡∏∏‡∏î 3 ‡∏à‡∏∏‡∏î</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>‡πÅ‡∏ä‡∏£‡πå</b><br>‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <b>"‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô" (Open in Safari/Chrome)</b></p>
  </div>

<div id="loginScreen" class="fade-in">
    
    <div class="card p-4 mb-3"> 
      <div class="text-center mb-3">
        <img id="loginLogo" src="" alt="Company Logo" style="width: 80px; height: auto; display: none;">
      </div>
      
      <h3 class="text-center mb-2">‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h3>
      <p class="text-center text-muted mb-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô</p>
      
      <input type="text" id="loginInput" class="form-control mb-3" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (User ID)">
      <input type="password" id="loginPass" class="form-control mb-4" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)">
      
      <div id="loginErrorMsg" class="text-danger small fw-bold mb-3" style="display:none; min-height: 20px;"></div>

      <button id="btnLogin" onclick="doLogin()" class="btn btn-primary w-100 py-2 fw-bold mb-2" disabled>
         ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö...
      </button>
      
      <button id="btnFaceLogin" onclick="startFaceLogin()" class="btn btn-outline-primary w-100 mt-2" disabled>
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î AI...
      </button>

    </div>

    <div class="mt-4 mb-4">
        <div class="bg-white rounded-4 shadow-sm p-3 mx-auto text-center" style="max-width: 90%;">
            
            <div class="d-flex align-items-center justify-content-center gap-2 mb-1">
                <img id="footerLogo" src="" style="height: 30px; width: auto; display: none;">
                <span class="fw-bold text-dark" style="font-size: 0.95rem; letter-spacing: 0.3px;">
                    <span class="companyNameText">Loading...</span>
                </span>
            </div>
            
            <div class="text-secondary small mt-1" style="font-size: 0.75rem;">
                ¬© 2026 Time Attendance System
            </div>
            
        </div>
    </div>

  </div>

  
  <div id="dashboardScreen" class="hidden fade-in" style="background-color: #f4f7f6; height: 100%; display: flex; flex-direction: column;">
     <header style="flex-shrink: 0; position: relative; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">

      <div class="bg-white py-2 px-3 d-flex justify-content-between align-items-center border-bottom">
          <div class="d-flex align-items-center">
             <img id="headerLogo" src="" alt="Logo" style="height: 32px; width: auto; object-fit: contain; display:none;" class="me-2">
             <span class="fw-bold text-dark companyNameText" style="font-size: 1rem; letter-spacing: 0.3px;"></span>
          </div>
          <button id="btnBackToHome" onclick="showPortal()" class="btn btn-light rounded-circle shadow-sm p-0 hidden" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border: 1px solid #eee;">
                <i class="bi bi-grid-fill text-primary" style="font-size: 1.1rem;"></i>
           </button>
      </div>
      
      <div class="bg-primary text-white px-3 py-3" style="border-radius: 0 0 20px 20px; background: linear-gradient(135deg, var(--bs-primary), #0a58ca);">
        <div class="d-flex align-items-center px-2">
          <div class="me-3 bg-white rounded-circle d-flex justify-content-center align-items-center overflow-hidden shadow" style="width: 50px; height: 50px; border: 2px solid rgba(255,255,255,0.9);">
            <img id="userProfileImg" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
            <span id="defaultUserIcon" style="font-size: 24px; color: #ccc; display:none;">üë§</span>
          </div>
          <div>
             <h5 id="userNameDisplay" class="mb-0 fw-bold" style="text-shadow: 0 1px 2px rgba(0,0,0,0.1); font-size: 1.1rem;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h5>
             <small id="currentDateDisplay" class="opacity-75" style="font-size: 0.8rem; display: block; font-weight: 300;"></small>
          </div>
        </div>
      </div>
    </header>

    <div class="container-fluid px-3 pb-4" style="flex-grow: 1; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; position: relative; z-index: 1; margin-top: -20px; padding-top: 10px;">

      <div id="portalSection" class="px-1">
          <div class="bg-white rounded-4 p-3 shadow-sm">
             <h6 class="text-muted mb-3 small fw-bold text-uppercase ps-2 border-start border-3 border-primary">‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (My Apps)</h6>
             <div id="appGrid" class="app-grid">
                 </div>
          </div>
          <div class="mt-4 px-2">
              <button onclick="doLogout()" class="btn btn-outline-danger w-100 rounded-pill py-2 fw-bold" style="border-width: 2px;">
                  <i class="bi bi-box-arrow-right me-2"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
              </button>
          </div>
      </div>

      <div id="taAppSection" class="hidden px-1">
          <div class="card p-3 mb-3 shadow-sm border-0">
              <label class="form-label fw-bold small text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥:</label>
              <input type="date" id="historyDate" class="form-control mb-3" onchange="loadHistory()">
              
              <div id="liveLocationSection" class="hidden text-center mb-3">
                  <div id="liveMap"></div>
                  <div class="status-badge-box">
                      <span id="locationStatusIcon">‚Üª</span> <span id="locationStatusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î...</span>
                  </div>
                  <div id="liveClock" style="font-family: 'Courier New', monospace; letter-spacing: -1px;">--:--:--</div>
              </div>

              <button id="btnScan" onclick="openCamera()" class="btn btn-warning w-100 py-3 text-white fw-bold shadow-sm hidden" style="border-radius: 12px; font-size: 1.1rem;">
                üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Scan)
              </button>
          </div>

          <div class="card p-3 shadow-sm border-0">
              <h6 class="border-bottom pb-2 mb-3 fw-bold text-primary">
                  <i class="bi bi-clock-history me-1"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
              </h6>
              <ul id="historyList" class="list-group list-group-flush small"></ul>
          </div>
      </div>

      <div id="adminDashboardSection" class="hidden px-1">
         
         <div class="card p-3 mb-3 shadow-sm border-0">
            <h5 class="fw-bold text-primary mb-3"><i class="bi bi-pie-chart-fill"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h5>
            
            <div class="d-flex gap-2 mb-3">
               
               <input type="date" id="statsDate" class="form-control form-control-sm" onchange="clearDashboard()">
               <button onclick="loadStats()" class="btn btn-sm btn-primary" style="width: 40px;" title="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">
                  <i class="bi bi-search"></i>
               </button>
            </div>

            <div class="chart-container-main">
               <canvas id="mainAreaChart"></canvas>
               <div class="center-text-overlay">
                  <div class="center-label">‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
                  <div class="center-value" id="centerTotalDisplay">0</div>
                  <div class="center-label">‡∏Ñ‡∏ô</div>
               </div>
            </div>
         </div>

         <div id="subChartsArea" class="row g-2">
        </div>

      </div>

      <div id="adminUserSection" class="hidden px-1">
         <div class="card shadow-sm border-0 card-full-width" style="height: 85vh; display: flex; flex-direction: column;">
            
            <div class="p-3 border-bottom bg-white" style="flex-shrink: 0;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                   <h5 class="fw-bold text-primary m-0"><i class="bi bi-people-fill"></i> ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h5>
                   <button onclick="openUserModal('add')" class="btn btn-sm btn-success fw-bold shadow-sm">
                       <i class="bi bi-person-plus-fill"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°
                   </button>
                </div>
                
                <div class="d-flex gap-2">
                   <select id="filterDept" class="form-select form-select-sm" style="width: 140px;" onchange="filterUserTable()">
                       <option value="">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>
                       </select>
                   <div class="input-group input-group-sm">
                       <span class="input-group-text bg-light border-end-0"><i class="bi bi-search text-muted"></i></span>
                       <input type="text" id="searchUser" class="form-control border-start-0 bg-light" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ / ‡∏£‡∏´‡∏±‡∏™..." onkeyup="filterUserTable()">
                   </div>
                </div>
            </div>

            <div class="table-wrapper bg-white">
               <table class="table table-hover table-mobile align-middle mb-0">
                  <thead class="table-light sticky-header">
                      <tr>
                          <th class="col-img">‡∏£‡∏π‡∏õ</th>
                          <th class="col-info">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                          <th class="col-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                          <th class="col-action">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
                      </tr>
                  </thead>
                  <tbody id="userTableBody">
                      </tbody>
               </table>
            </div>
         </div>
      </div>

      <div id="adminImportPayslipSection" class="hidden px-1 fade-in">
          <div class="card p-4 shadow-sm border-0 mb-3">
              <h5 class="fw-bold text-primary mb-3"><i class="bi bi-file-earmark-excel"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Payslip (CSV)</h5>
              <div class="mb-3">
                  <label class="form-label small fw-bold">‡∏£‡∏∞‡∏ö‡∏∏‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô 01/2568)</label>
                  <input type="text" id="importPeriod" class="form-control" placeholder="‡∏î‡∏î/‡∏õ‡∏õ‡∏õ‡∏õ">
              </div>
              <div class="mb-3">
                  <label class="form-label small fw-bold">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ .csv)</label>
                  <input type="file" id="csvFileInput" class="form-control" accept=".csv">
              </div>
              <button onclick="processPayslipCSV()" class="btn btn-success w-100 fw-bold"><i class="bi bi-upload"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
          </div>
      </div>
    
      <div id="userPayslipSection" class="hidden px-0 fade-in mt-4">
          <div id="payslipCard" class="card shadow-sm border-0 hidden mx-2 mb-3">
              <!--
              <div class="bg-primary text-white p-2 rounded-top d-flex justify-content-between align-items-start">
                  <div>
                      <h6 class="m-0 fw-bold mb-1">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h6>
                      <small id="ps_empNameDisplay" class="fw-bold text-warning" style="font-size: 0.85rem;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</small>
                  </div>
                  <div class="text-end">
                      <select id="payslipPeriodSelect" class="form-select form-select-sm bg-white text-primary fw-bold border-0 shadow-sm mb-1 py-1" style="border-radius: 6px; cursor: pointer; min-width: 90px; font-size: 0.8rem;" onchange="loadPayslipData()">
                          <option value="" selected disabled>‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏ß‡∏î...</option>
                      </select>
                      <small id="ps_date" class="opacity-75 d-block mt-1" style="font-size: 0.7rem;">‡∏à‡πà‡∏≤‡∏¢: -</small>
                  </div>
              </div> -->
              <div class="bg-primary text-white p-2 rounded-top d-flex justify-content-between align-items-center">
                  
                  <div class="d-flex align-items-center">
                      <div class="me-3">
                          <h6 class="m-0 fw-bold mb-1">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h6>
                          <small id="ps_empNameDisplay" class="fw-bold text-warning" style="font-size: 0.85rem;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</small>
                      </div>
                      
                      <img id="ps_empProfileImg" src="" class="rounded-circle border border-2 border-white shadow-sm" style="width: 50px; height: 50px; object-fit: cover; display: none;">
                  </div>

                  <div class="text-end">
                      <select id="payslipPeriodSelect" class="form-select form-select-sm bg-white text-primary fw-bold border-0 shadow-sm mb-1 py-1" style="border-radius: 6px; cursor: pointer; min-width: 90px; font-size: 0.8rem;" onchange="loadPayslipData()">
                          <option value="" selected disabled>‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏ß‡∏î...</option>
                      </select>
                      <small id="ps_date" class="opacity-75 d-block mt-1" style="font-size: 0.7rem;">‡∏à‡πà‡∏≤‡∏¢: -</small>
                  </div>
              </div>

              <div class="p-2 bg-light border-bottom" style="font-size: 0.8rem;">
                  <div class="d-flex justify-content-between align-items-center text-muted mb-1">
                      <div class="d-flex align-items-center">
                          <span class="me-1">‡∏£‡∏´‡∏±‡∏™:</span>
                          <strong class="text-dark" id="ps_empNo_text" style="display:none;">-</strong>
                          
                          <div id="ps_empNo_input_group" class="input-group input-group-sm shadow-sm" style="width: 140px; display:none;">
                              <input type="text" id="ps_searchEmpInput" class="form-control text-center fw-bold text-primary" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™">
                              <button class="btn btn-primary" onclick="searchPayslip()"><i class="bi bi-search"></i></button>
                          </div>
                      </div>
                      <span>‡πÅ‡∏ú‡∏ô‡∏Å: <strong class="text-dark" id="ps_dept">-</strong></span>
                  </div>
                  <div class="d-flex justify-content-between text-muted">
                      <span>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£: <strong class="text-dark" id="ps_bank">-</strong> <span id="ps_accNo"></span></span>
                      <span>‡∏ê‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: <strong class="text-dark" id="ps_baseSalary">-</strong></span>
                  </div>
              </div>

              <div class="p-2">
                  <div class="row g-2">
                      <div class="col-6 border-end pe-2">
                          <h6 class="fw-bold text-primary border-bottom pb-1 mb-2" style="font-size: 0.85rem;"><i class="bi bi-plus-circle"></i> ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</h6>
                          <div id="ps_incomeList" style="font-size: 0.75rem;"></div>
                          <div class="d-flex justify-content-between fw-bold text-primary mt-2 pt-1 border-top" style="font-size: 0.8rem;">
                              <span>‡∏£‡∏ß‡∏°‡∏£‡∏±‡∏ö :</span>
                              <span id="ps_totalIncome">0</span>
                          </div>
                      </div>
                      
                      <div class="col-6 ps-2">
                          <h6 class="fw-bold text-danger border-bottom pb-1 mb-2" style="font-size: 0.85rem;"><i class="bi bi-dash-circle"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å</h6>
                          <div id="ps_deductList" style="font-size: 0.75rem;"></div>
                          <div class="d-flex justify-content-between fw-bold text-danger mt-2 pt-1 border-top" style="font-size: 0.8rem;">
                              <span>‡∏£‡∏ß‡∏°‡∏´‡∏±‡∏Å :</span>
                              <span id="ps_totalDeduct">0</span>
                          </div>
                      </div>
                  </div>
              </div>

              <div class="p-2 px-3 bg-success text-white d-flex justify-content-between align-items-center">
                  <span class="fw-bold" style="font-size: 0.9rem;">‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                  <h4 class="m-0 fw-bold" id="ps_netPay">0</h4>
              </div>

              <div class="bg-primary text-white p-2 rounded-bottom" style="font-size: 0.75rem;">
                  <div class="row g-0">
                      <div class="col-4 border-end border-light border-opacity-25 px-2">
                          <div class="text-start opacity-75" style="font-size: 0.65rem;">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏™‡∏°</div>
                          <div class="fw-bold text-end mt-1" id="ps_accIncome">0</div>
                      </div>
                      <div class="col-4 border-end border-light border-opacity-25 px-2">
                          <div class="text-start opacity-75" style="font-size: 0.65rem;">‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏∞‡∏™‡∏°</div>
                          <div class="fw-bold text-end mt-1" id="ps_accTax">0</div>
                      </div>
                      <div class="col-4 px-2">
                          <div class="text-start opacity-75" style="font-size: 0.65rem;">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏™‡∏∞‡∏™‡∏°</div>
                          <div class="fw-bold text-end mt-1" id="ps_accSSO">0</div>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      

    </div>
  </div>

  <div id="setupPassScreen" class="card p-4 hidden fade-in">
    <h4 class="text-center mb-3 text-warning">üîê ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h4>
    <p class="text-center small text-muted">‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</p>
    <div class="alert alert-light text-center border mb-3">
        <div class="fw-bold text-primary" id="setupShowName" style="font-size: 1.1rem;">-</div>
        <small class="text-muted">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <span id="setupShowId">-</span></small>
    </div>
    <input type="hidden" id="setupEmpId">
    <div class="mb-3">
        <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
        <input type="password" id="newPass" class="form-control" placeholder=">= 8 ‡∏ï‡∏±‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‡πÄ‡∏•‡πá‡∏Å/‡πÉ‡∏´‡∏ç‡πà/‡πÄ‡∏•‡∏Ç/‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©">
    </div>
    <div class="mb-4">
        <label class="form-label">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
        <input type="password" id="confirmPass" class="form-control" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ã‡πâ‡∏≥‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á">
    </div>
    <button onclick="doSubmitNewPassword()" class="btn btn-warning w-100 fw-bold text-white">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <button onclick="showLogin()" class="btn btn-link w-100 mt-2 text-muted">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>

  <div id="registerScreen" class="card p-4 hidden">
    <h4 class="text-center mb-3">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h4>
    <input type="text" id="regEmpId" class="form-control mb-2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">
    <input type="text" id="regFname" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠">
    <input type="text" id="regLname" class="form-control mb-2" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
    <select id="regDept" class="form-select mb-2">
      <option value="" selected disabled>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å...</option>
    </select>
    <input type="email" id="regEmail" class="form-control mb-2" placeholder="Email">
    <input type="password" id="regPass" class="form-control mb-2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (8+ ‡∏ï‡∏±‡∏ß, ‡πÉ‡∏´‡∏ç‡πà, ‡πÄ‡∏•‡πá‡∏Å, ‡πÄ‡∏•‡∏Ç, ‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©)">
    <input type="password" id="regConfirmPass" class="form-control mb-2" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
    <small class="text-danger hidden" id="passError">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</small>
    <button onclick="doRegister()" class="btn btn-success w-100 mt-3">‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™ OTP</button>
    <button onclick="showLogin()" class="btn btn-link w-100 mt-1">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Login</button>
  </div>

  <div id="otpScreen" class="card p-4 hidden">
    <h4 class="text-center">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™ OTP</h4>
    <p class="text-center text-muted">‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà Email ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß</p>
    <input type="text" id="otpInput" class="form-control mb-3 text-center" placeholder="XXXXXX" maxlength="6">
    <button onclick="doConfirmOTP()" class="btn btn-primary w-100">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
  </div>

  <div id="faceLoginModal" class="modal-overlay hidden">
    <div class="modal-content-box">
        <div class="text-center">
            <h5 class="mb-3 fw-bold text-primary"><i class="bi bi-person-check-fill"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h5>
            <div id="faceLoading" class="text-warning small mb-2 fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á...</div>
            <div style="position: relative; width: 100%; height: 300px; background: #000; border-radius: 10px; overflow: hidden; margin: 0 auto;">
                <video id="faceVideo" autoplay muted playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
                <canvas id="faceCanvas" style="position: absolute; top: 0; left: 0;"></canvas>
            </div>
            <div id="faceStatus" class="mt-3 text-dark small fw-bold">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á</div>
            <button onclick="closeFaceLogin()" class="btn btn-secondary mt-3 w-100 rounded-pill">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
  </div>

  <div id="cameraModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:9999; display:none; flex-direction:column; justify-content:center; align-items:center;">
    
    <div style="position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center;">
        
        <video id="videoFeed" autoplay playsinline 
               style="width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1);">
        </video>
        
        <canvas id="scanOverlay" 
                style="position:absolute; top:0; left:0; width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1);">
        </canvas>

    </div>

    <div style="position:absolute; bottom:50px; width:100%; text-align:center; z-index:10000;">
      <div id="scanStatusBox" class="bg-white px-4 py-2 rounded-pill shadow-sm d-inline-block">
          <span class="spinner-border spinner-border-sm text-primary" role="status"></span>
          <span class="fw-bold text-dark ms-2" id="scanStatusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...</span>
      </div>
      <br><br>
      <button onclick="closeCamera()" class="btn btn-outline-light btn-sm px-4 rounded-pill">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>

  <div class="modal fade" id="userFormModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-primary text-white">
          <h6 class="modal-title fw-bold" id="userModalTitle"><i class="bi bi-person-lines-fill"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h6>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-3">
           <form id="userForm">
              <input type="hidden" id="formMode">
              
              <div class="row g-2 mb-2">
                 <div class="col-4">
                     <label class="small fw-bold text-muted">‡∏£‡∏´‡∏±‡∏™</label>
                     <input type="text" id="u_empId" class="form-control form-control-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô 001">
                 </div>
                 <div class="col-8">
                     <label class="small fw-bold text-muted">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                     <input type="email" id="u_email" class="form-control form-control-sm">
                 </div>
              </div>

              <div class="row g-2 mb-2">
                 <div class="col-6">
                     <label class="small fw-bold text-muted">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á</label>
                     <input type="text" id="u_fname" class="form-control form-control-sm">
                 </div>
                 <div class="col-6">
                     <label class="small fw-bold text-muted">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                     <input type="text" id="u_lname" class="form-control form-control-sm">
                 </div>
              </div>

              <div class="mb-2">
                  <label class="small fw-bold text-muted">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                  <select id="u_dept" class="form-select form-select-sm bg-light">
                      <option value="" selected disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>
                  </select>
              </div>

              <div class="row g-2 mb-3">
                 <div class="col-6">
                     <label class="small fw-bold text-muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                     <select id="u_status" class="form-select form-select-sm">
                        <option value="Active" class="text-success fw-bold">Active (‡∏õ‡∏Å‡∏ï‡∏¥)</option>
                        <option value="Inactive" class="text-danger">Inactive (‡∏•‡∏≤‡∏≠‡∏≠‡∏Å)</option>
                        <option value="Admin" class="text-primary fw-bold">Admin</option>
                     </select>
                 </div>
                 <div class="col-6">
                     <label class="small fw-bold text-muted">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</label>
                     <input type="date" id="u_startDate" class="form-control form-control-sm">
                 </div>
              </div>
              
              <div id="editTools" class="border-top pt-2 mt-2 hidden">
                  <label class="small fw-bold text-muted mb-2">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏û‡∏¥‡πÄ‡∏®‡∏©</label>
                  <div class="d-flex gap-2">
                      <button type="button" class="btn btn-sm btn-outline-warning w-100" onclick="resetUserField('password')">
                          <i class="bi bi-key"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-danger w-100" onclick="resetUserField('token')">
                          <i class="bi bi-phone"></i> ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
                      </button>
                  </div>
              </div>

              <div class="mb-3 border p-2 rounded bg-light">
                  <label class="small fw-bold text-muted mb-1">‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
                  <input type="file" id="u_photoFile" class="form-control form-control-sm mb-2" accept="image/*" onchange="previewImage(this)">
                  <input type="hidden" id="u_currentPhotoId"> 
                  <div class="text-center">
                      <img id="u_previewImg" src="" class="rounded shadow-sm hidden" style="max-height: 100px; max-width: 100%;">
                      <div id="u_noImageText" class="text-muted small py-2">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -</div>
                  </div>
              </div>

              <div class="mb-3">
                  <label class="small fw-bold text-muted mb-1">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Allowed Systems)</label>
                  <div id="systemCheckboxContainer" class="border rounded p-2 bg-white" style="max-height: 100px; overflow-y: auto;">
                      </div>
                  <div class="form-check mt-1">
                      <input class="form-check-input" type="checkbox" id="chk_AllSystems" onchange="toggleAllSystems()">
                      <label class="form-check-label small text-primary" for="chk_AllSystems">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</label>
                  </div>
              </div>

           </form>
        </div>
        <div class="modal-footer bg-light py-2">
           <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
           <button type="button" class="btn btn-primary btn-sm px-4 fw-bold" onclick="saveUser()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </div>
    </div>
  </div>
  
  <div id="tokenDebug" class="token-debug"></div>

</div>

<script>
  // ==========================================
  // 1. CONFIGURATION
  // ==========================================
  
  // *** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏™‡πà URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å New Deployment Code.gs ***

  const API_URL = "https://script.google.com/macros/s/AKfycbwYa587lK3EQ39Do1k-Xoy97rmYdI2PS4koJDAixkO9zw6S2YqPLO6eVix9l-IEp2bC/exec" ; 

  const APP_CONFIG = {
      COMPANY_NAME: '‡∏ß‡∏¥‡∏™‡∏î‡∏≠‡∏° ‡∏≠‡∏≠‡πÇ‡∏ï‡πâ‡∏û‡∏≤‡∏£‡πå‡∏ó ‡∏à‡∏≥‡∏Å‡∏±‡∏î',
      
      // 1. ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÄ‡∏•‡πá‡∏Å (Header ‡∏´‡∏ô‡πâ‡∏≤ Dashboard)
      LOGO_HEADER: 'https://drive.google.com/thumbnail?id=1RbfQoTcWEU6Y4USFIV9XjmAjgpx87hvA&sz=w1000', 
      
      // 2. ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÉ‡∏´‡∏ç‡πà (‡∏´‡∏ô‡πâ‡∏≤ Login ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô")
      // ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      LOGO_LOGIN: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png' 
  };


  // ==========================================
  // 2. CORE LOGIC
  // ==========================================

  var currentUser = null;
  var referenceFaceDescriptor = null; // *** ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ ***
  var isScanning = false;
  

  var matchCounter = 0; // ‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
  const REQUIRED_MATCHES = 6; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 1-1.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)

  var tempEmail = '';
  var lastScanTime = null; 
  var myDeviceToken = null; 
  var isAutoLoginCancelled = false; 

  var mapObj = null;
  var userMarker = null;
  var areaCircle = null;
  var watchId = null;
  var clockInterval = null;
  var targetLat = 0;
  var targetLng = 0;
  var allowedRadius = 0;
  var isLocationValid = false;
  var isHistoryLoaded = false;

  var pendingBroadcastData = { msg: null, token: null, name: null, photo: null, allowedApps: null, sysConfig: null };
  var userAllowedApps = [];
  var systemConfigList = [];

  document.addEventListener('DOMContentLoaded', async function() {
    setupUIFromConfig();

    var ua = navigator.userAgent || navigator.vendor || window.opera;
    var isInApp = (ua.indexOf("FBAN") > -1) || (ua.indexOf("FBAV") > -1) || (ua.indexOf("Line") > -1);
    if (isInApp) { document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('inAppAlert').classList.remove('hidden'); return; }

    await initDeviceToken();
    
    var btnLogin = document.getElementById('btnLogin');
    btnLogin.disabled = false;
    btnLogin.innerText = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';

    checkAutoLogin();
    
    document.getElementById('loginPass').addEventListener("keypress", function(event) {
      if (event.key === "Enter") doLogin();
    });

    document.getElementById('loginInput').addEventListener('input', function() {
        resetSystemState(); 
    });
    
    loadFaceModels();
  });

  function setupUIFromConfig() {
      document.getElementById('loginLogo').src = APP_CONFIG.LOGO_LOGIN;
      document.getElementById('loginLogo').style.display = 'inline-block';
      document.getElementById('footerLogo').src = APP_CONFIG.LOGO_HEADER;
      document.getElementById('footerLogo').style.display = 'block';
      document.getElementById('headerLogo').src = APP_CONFIG.LOGO_HEADER;
      document.getElementById('headerLogo').style.display = 'block';
      const nameEls = document.querySelectorAll('.companyNameText');
      nameEls.forEach(el => el.innerText = APP_CONFIG.COMPANY_NAME);
  }

  // --- API HANDLER (FIXED) ---
  async function callAPI(data, callback) {
      try {
          const response = await fetch(API_URL, {
              method: "POST",
              body: JSON.stringify(data),
              headers: { "Content-Type": "text/plain;charset=utf-8" } 
          });
          
          const result = await response.json();
          if (callback) callback(result);
          return result;

      } catch (error) {
          console.error("API Error:", error);
          Swal.fire({ icon: 'error', title: 'Connection Error', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ' });
          return { status: 'error', message: error.toString() };
      }
  }

  function resetSystemState() {
      if (!isAutoLoginCancelled) {
          isAutoLoginCancelled = true;
          localStorage.removeItem('saved_emp_id');
          closeFaceLogin();
          const video = document.getElementById('faceVideo');
          if (video.srcObject) { 
              video.srcObject.getTracks().forEach(t => t.stop()); 
              video.srcObject = null;
          }
      }
  }

  // --- MAP & LOCATION LOGIC ---
  function initMap() {
      if (!mapObj) {
          mapObj = L.map('liveMap', { zoomControl: false }).setView([13.7563, 100.5018], 15);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '¬© OpenStreetMap'
          }).addTo(mapObj);
      }
      
      // FIXED: Use callAPI
      callAPI({ action: 'getEmpConfig', empId: currentUser }, function(config) {
          if (config && config.lat && config.lng) {
              targetLat = config.lat;
              targetLng = config.lng;
              allowedRadius = config.dist || 500;
              startWatchingLocation();
          }
      });
  }

  function startWatchingLocation() {
      if (navigator.geolocation) {
          watchId = navigator.geolocation.watchPosition(function(position) {
              var lat = position.coords.latitude;
              var lng = position.coords.longitude;
              updateMapPosition(lat, lng);
          }, function(error) {
              console.error("GPS Error", error);
              document.getElementById('locationStatusText').innerText = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS";
              document.getElementById('locationStatusText').style.color = 'red';
              document.getElementById('btnScan').classList.add('hidden'); 
          }, { enableHighAccuracy: true, maximumAge: 10000, timeout: 30000 });
      }
  }

  function updateMapPosition(lat, lng) {
      if (!mapObj) return;

      var center = [lat, lng];
      if (userMarker) {
          userMarker.setLatLng(center);
      } else {
          var userIcon = L.divIcon({
              className: 'user-pin',
              html: '<div style="background-color: #0d6efd; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.5);"></div>',
              iconSize: [15, 15]
          });
          userMarker = L.marker(center, {icon: userIcon}).addTo(mapObj);
      }
      mapObj.setView(center);

      var dist = getDistanceFromLatLonInKm(lat, lng, targetLat, targetLng) * 1000;
      
      if (areaCircle) mapObj.removeLayer(areaCircle);

      var statusText = document.getElementById('locationStatusText');
      var statusIcon = document.getElementById('locationStatusIcon');
      var statusBox = document.querySelector('.status-badge-box');
      
      if (dist <= allowedRadius) {
          areaCircle = L.circle([targetLat, targetLng], {
              color: '#28a745',
              fillColor: '#28a745',
              fillOpacity: 0.3,
              radius: allowedRadius
          }).addTo(mapObj);
          
          statusText.innerText = "‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (" + Math.round(dist) + " ‡∏°.)";
          statusIcon.innerText = "‚úî";
          statusBox.style.borderColor = "#28a745";
          statusBox.style.color = "#28a745";
          statusBox.style.backgroundColor = "#e8f5e9";
          isLocationValid = true;
          checkScanAvailability();
      } else {
          statusText.innerText = "‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏´‡πà‡∏≤‡∏á " + (dist/1000).toFixed(2) + " ‡∏Å‡∏°.)";
          statusIcon.innerText = "‚úñ";
          statusBox.style.borderColor = "#dc3545";
          statusBox.style.color = "#dc3545";
          statusBox.style.backgroundColor = "#f8d7da";
          isLocationValid = false;
          checkScanAvailability();
      }
  }

  function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
      var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1);
      var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
  }
  function deg2rad(deg) { return deg * (Math.PI/180); }

  function startClock() {
      if (clockInterval) clearInterval(clockInterval);
      function update() {
          var now = new Date();
          var timeStr = now.toLocaleTimeString('th-TH', { hour12: false });
          document.getElementById('liveClock').innerText = timeStr;
      }
      update();
      clockInterval = setInterval(update, 1000);
  }
  function stopClock() { if (clockInterval) clearInterval(clockInterval); }


  // --- GENERAL FUNCTIONS ---
  function loginSuccess(token, name, photoUrl, allowedApps, sysConfig) { 
      currentUser = token; 
      localStorage.setItem('saved_emp_id', token); 

      userAllowedApps = allowedApps ? allowedApps.split(',') : ['TA']; 
      systemConfigList = sysConfig || [];

      if(photoUrl) localStorage.setItem('saved_user_photo', photoUrl);
      document.getElementById('userNameDisplay').innerText = name;
      var imgEl = document.getElementById('userProfileImg'); var iconEl = document.getElementById('defaultUserIcon');
      if(!photoUrl) photoUrl = localStorage.getItem('saved_user_photo');
      if (photoUrl && photoUrl.trim() !== "") { imgEl.src = photoUrl; imgEl.style.display = 'block'; iconEl.style.display = 'none'; } else { imgEl.style.display = 'none'; iconEl.style.display = 'block'; }

      // *** ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô ***
      if (photoUrl) {
          prepareReferenceFaceForScan(photoUrl);
      }  

      renderPortalApps();
      showDashboard();
  }

  // *** ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• AI ***
  async function prepareReferenceFaceForScan(photoUrl) {
      try {
          if (!faceModelsLoaded) await loadFaceModels();
          const img = await faceapi.fetchImage(photoUrl);
          const detections = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
          if (detections) {
              referenceFaceDescriptor = detections.descriptor;
              console.log("Reference face loaded ready for scan.");
          }
      } catch (e) { console.error("Load reference face failed", e); }
  }

  function renderPortalApps() {
      var grid = document.getElementById('appGrid');
      grid.innerHTML = '';

      if (systemConfigList.length === 0) {
           grid.innerHTML = '<p class="text-muted small w-100">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>';
           return;
      }

      systemConfigList.forEach(function(sys) {
          if (userAllowedApps.includes(sys.id) || userAllowedApps.includes('All')) {
              var card = document.createElement('div');
              card.className = 'app-card fade-in';
              card.onclick = function() { openApp(sys.id); };
              
              var iconVal = sys.icon || 'fa-solid fa-circle-question'; 
              var iconHtml = '';

              if (iconVal.includes('http') || iconVal.includes('data:image')) {
                  iconHtml = `<img src="${iconVal}" class="app-icon" style="width: 50px; height: 50px; object-fit: contain; margin-bottom: 8px;">`;
              } else {
                  iconHtml = `<div class="mb-2"><i class="${iconVal}" style="font-size: 40px; color: #0d6efd;"></i></div>`;
              }
              
              card.innerHTML = `
                  ${iconHtml}
                  <div class="app-name">${sys.name}</div>
              `;
              grid.appendChild(card);
          }
      });
  }

  
  function showPortal() {
      if (watchId) navigator.geolocation.clearWatch(watchId);
      stopClock();

      var allSections = [
          'taAppSection', 
          'adminDashboardSection', 
          'adminVerifySection', 
          'adminUserSection',
          'adminImportPayslipSection', 
          'userPayslipSection'
      ];
      
      allSections.forEach(function(id) {
          var el = document.getElementById(id);
          if (el) el.classList.add('hidden');
      });

      document.getElementById('portalSection').classList.remove('hidden');
      document.getElementById('btnBackToHome').classList.add('hidden'); 
  }

function showDashboard() { 
    hideAll(); 
    document.getElementById('dashboardScreen').classList.remove('hidden');
    document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    showPortal();
  }

function loadHistory() { 
    isHistoryLoaded = false; 
    checkScanAvailability(); 

    var date = document.getElementById('historyDate').value;
    var today = getLocalDateString();
    
    if (date === today) {
        document.getElementById('liveLocationSection').classList.remove('hidden');
        document.getElementById('btnScan').classList.add('hidden'); 
        setTimeout(() => { 
            initMap(); 
            if(mapObj) mapObj.invalidateSize(); 
        }, 300);
        startClock();
    } else {
        document.getElementById('liveLocationSection').classList.add('hidden');
        if (watchId) navigator.geolocation.clearWatch(watchId);
        stopClock();
    }

    callAPI({ action: 'getHistory', empId: currentUser, filterDate: date }, function(res) { 
        var list = document.getElementById('historyList'); 
        list.innerHTML = ''; 
        lastScanTime = null; 
        
        if (res.status !== 'success') {
             list.innerHTML = '<li class="list-group-item text-center text-danger">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (res.message || 'Unknown Error') + '</li>';
             isHistoryLoaded = true;
             checkScanAvailability();
             return;
        }

        if(res.data.length === 0) { 
            list.innerHTML = '<li class="list-group-item text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô</li>'; 
        } else { 
            var lastItem = res.data[res.data.length - 1];
            lastScanTime = lastItem.time; 
        } 
        
        res.data.forEach(function(item) { 
            var li = `<li class="list-group-item d-flex justify-content-between align-items-center"><span>‚è∞ ${item.time}</span><a href="https://www.google.com/maps/search/?api=1&query=${item.lat},${item.lng}" target="_blank" class="btn btn-sm btn-outline-info">Map</a></li>`; 
            list.innerHTML += li; 
        }); 
        isHistoryLoaded = true; 
        checkScanAvailability();
    }); 
  }

  function checkScanAvailability() {
      var btn = document.getElementById('btnScan');
      var locSection = document.getElementById('liveLocationSection'); // <--- 1. ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏™‡πà‡∏ß‡∏ô Location
      
      var dateVal = document.getElementById('historyDate').value;
      var today = getLocalDateString();

      // ‡∏Å‡∏£‡∏ì‡∏µ‡∏î‡∏π‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
      if (dateVal !== today) {
          btn.disabled = true;
          btn.classList.remove('hidden'); 
          btn.classList.add('btn-secondary');
          btn.classList.remove('btn-primary', 'btn-warning');
          btn.innerHTML = 'üö´ ‡∏î‡∏π‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (‡∏á‡∏î‡∏™‡πÅ‡∏Å‡∏ô)';
          
          locSection.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
          return;
      }

      // ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à
      if (!isHistoryLoaded) {
          btn.classList.remove('hidden'); 
          btn.disabled = true;            
          btn.classList.add('btn-secondary');
          btn.classList.remove('btn-primary', 'btn-warning');
          btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...'; 
          return;
      }

      // ‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡πÅ‡∏Å‡∏ô‡∏ñ‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏ï‡∏¥‡∏î Cooldown)
      if (lastScanTime) {
          var now = new Date();
          var last = new Date();
          var parts = lastScanTime.split(':');
          last.setHours(parseInt(parts[0]), parseInt(parts[1]), parseInt(parts[2]), 0);

          // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏á (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)
          var nextScanTime = new Date(last.getTime() + (2 * 60 * 60 * 1000));

          if (now < nextScanTime) {
              var timeStr = nextScanTime.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
              
              btn.classList.remove('hidden');
              btn.disabled = true; 
              btn.classList.add('btn-secondary');
              btn.classList.remove('btn-primary', 'btn-warning');
              btn.innerHTML = `‚è≥ ‡∏£‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ${timeStr}`;
              
              // *** 2. ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡πÄ‡∏ß‡∏•‡∏≤ ***
              locSection.classList.add('hidden'); 
              return;
          }
      }

      // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô ---
      
      // *** 3. ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ***
      locSection.classList.remove('hidden'); 

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö GPS (‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏±‡πà‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô Map ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏¥‡∏î)
      if (!isLocationValid) {
          btn.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
          return;
      }

      // ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
      btn.classList.remove('hidden');
      btn.disabled = false; 
      btn.classList.remove('btn-secondary', 'btn-warning');
      btn.classList.add('btn-primary');
      
      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°
      btn.innerHTML = '<i class="bi bi-person-bounding-box" style="font-size: 1.2rem;"></i> ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (Face Scan)'; 
  }
  
  function setCookie(name, value, days) { var expires = ""; if (days) { var date = new Date(); date.setTime(date.getTime() + (days*24*60*60*1000)); expires = "; expires=" + date.toUTCString(); } document.cookie = name + "=" + (value || "")  + expires + "; path=/"; }
  function getCookie(name) { var nameEQ = name + "="; var ca = document.cookie.split(';'); for(var i=0;i < ca.length;i++) { var c = ca[i]; while (c.charAt(0)==' ') c = c.substring(1,c.length); if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length); } return null; }

  async function initDeviceToken() {
      myDeviceToken = getCookie('my_device_token');
      if (!myDeviceToken) { try { myDeviceToken = await idbKeyval.get('my_device_token'); } catch (e) {} }
      if (!myDeviceToken) { myDeviceToken = localStorage.getItem('my_device_token'); }
      if (!myDeviceToken) { myDeviceToken = 'DEV-' + new Date().getTime() + '-' + Math.floor(Math.random() * 100000); }
      localStorage.setItem('my_device_token', myDeviceToken);
      setCookie('my_device_token', myDeviceToken, 3650);
      try { await idbKeyval.set('my_device_token', myDeviceToken); } catch (e) {}
      document.getElementById('tokenDebug').innerText = myDeviceToken;
  }
  function getDeviceToken() { return myDeviceToken; }

  // --- LOGIN ---
  function doLogin() {
    resetSystemState();
    
    var loginIdVal = document.getElementById('loginInput').value;
    var loginPassVal = document.getElementById('loginPass').value;
    var errBox = document.getElementById('loginErrorMsg');
    var btn = document.getElementById('btnLogin');
    
    errBox.style.display = 'none';
    errBox.innerText = '';
    
    if(!getDeviceToken()) {
        errBox.innerText = 'Error: ‡πÑ‡∏°‡πà‡∏û‡∏ö Device Token';
        errBox.style.display = 'block';
        return;
    }

    if(!loginIdVal) { errBox.innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å User ID'; errBox.style.display = 'block'; return; }

    var originalText = btn.innerText;
    btn.disabled = true; btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

    var data = { action: 'login', loginId: loginIdVal, password: loginPassVal, deviceToken: getDeviceToken(), os: getMobileOS() };
    
    callAPI(data, function(res) {
      btn.disabled = false; btn.innerText = originalText;
      if(res.status === 'success') { 
        if (res.broadcast && res.broadcast.toString().trim() !== "") {
              showBroadcast(res.broadcast, function() {
                  loginSuccess(res.token, res.name, res.photo, res.allowedApps, res.systemConfig); 
              });
        } else {
            loginSuccess(res.token, res.name, res.photo, res.allowedApps, res.systemConfig); 
        } 
      } else if (res.status === 'force_setup') {
        document.getElementById('setupEmpId').value = res.empId;
        document.getElementById('setupShowName').innerText = res.name;
        document.getElementById('setupShowId').innerText = res.empId;
        hideAll();
        document.getElementById('setupPassScreen').classList.remove('hidden');
        Swal.fire({ icon: 'info', title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' });
      } else {
        errBox.innerText = res.message || 'Login Error'; errBox.style.display = 'block';
      }
    });
  }

  function getMobileOS() {
    var ua = navigator.userAgent || navigator.vendor || window.opera;
    var platform = navigator.platform || "";
    if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) return 'iOS';
    if (platform === 'MacIntel' && navigator.maxTouchPoints > 1) return 'iOS'; 
    if (/android/i.test(ua)) return 'Android';
    return 'unknown';
  }

  function checkAutoLogin() {
    var savedEmpId = localStorage.getItem('saved_emp_id');
    var savedToken = getDeviceToken(); 
    if (savedEmpId) { document.getElementById('loginInput').value = savedEmpId; }

    if (savedEmpId && savedToken) {
      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } });
      var data = { action: 'autoLogin', empId: savedEmpId, deviceToken: savedToken };
      
      callAPI(data, function(res) {
        Swal.close();
        if (isAutoLoginCancelled) return; 

        if (res.status === 'success') {
           var finalLoginStep = function() {
               loginSuccess(res.token, res.name, res.photo, res.allowedApps, res.systemConfig);
           };

           var processBroadcast = function() {
                if (res.broadcast && res.broadcast.toString().trim() !== "") {
                    showBroadcast(res.broadcast, finalLoginStep);
                } else {
                    finalLoginStep();
                }
           };

           if (res.photo && res.photo.length > 100) {
               if (faceModelsLoaded) { 
                   startFaceLoginWithBroadcast(res.broadcast, res.token, res.name, res.photo, res.allowedApps, res.systemConfig); 
               } else {
                   Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...', didOpen: () => { Swal.showLoading() } });
                   var waitForAI = setInterval(function() {
                       if (isAutoLoginCancelled) { clearInterval(waitForAI); Swal.close(); return; } 
                       if (faceModelsLoaded) { 
                           clearInterval(waitForAI); 
                           Swal.close(); 
                           startFaceLoginWithBroadcast(res.broadcast, res.token, res.name, res.photo, res.allowedApps, res.systemConfig); 
                       }
                   }, 500);
               }
           } else { 
               processBroadcast();
           }
        } else { 
            showLogin(); 
        }
      });
    } else { 
        showLogin(); 
    }
  }

function startFaceLoginWithBroadcast(msg, token, name, photo, allowedApps, sysConfig) {
    pendingBroadcastData = { 
        msg: msg, 
        token: token, 
        name: name, 
        photo: photo, 
        allowedApps: allowedApps, 
        sysConfig: sysConfig      
    };
    startFaceLogin();
}

  function startFaceLogin() {
    closeFaceLogin(); 
    if (isAutoLoginCancelled) {
        var currentInput = document.getElementById('loginInput').value;
    }

    var empId = document.getElementById('loginInput').value;
    if (!empId) { Swal.fire('‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô', 'warning'); return; }
    
    if(!getDeviceToken()) {
        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö Device Token', 'error');
        return;
    }
    
    if (!faceModelsLoaded) { Swal.fire({ icon: 'error', title: 'AI ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°', text: '‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...' }); return; }

    document.getElementById('faceLoginModal').classList.remove('hidden');
    document.getElementById('faceStatus').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...';
    document.getElementById('faceLoading').innerText = '';

    if (pendingBroadcastData.photo) {
         try {
            document.getElementById('faceStatus').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...';
            prepareReferenceFace(pendingBroadcastData.photo, pendingBroadcastData.name)
            .then(() => {
                startFaceCamera(empId, pendingBroadcastData.name, pendingBroadcastData.photo, pendingBroadcastData.allowedApps, pendingBroadcastData.sysConfig);
            })
            .catch(err => {
                closeFaceLogin(); 
                Swal.fire('‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤', err.message, 'error'); 
            });
         } catch (err) { closeFaceLogin(); Swal.fire('Error', err.message, 'error'); }
    } else {
        // FIXED: Use callAPI
        callAPI({ action: 'getEmployeeFaceData', empId: empId, deviceToken: getDeviceToken() }, function(res) {
            var currentInput = document.getElementById('loginInput').value;
            if (currentInput !== empId) {
                 closeFaceLogin();
                 return;
            }

            if (res.status === 'success') {
                try {
                    document.getElementById('faceStatus').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...';
                    prepareReferenceFace(res.image, res.name).then(() => {
                        startFaceCamera(empId, res.name, res.image, res.allowedApps, res.systemConfig);
                    });
                } catch (err) { closeFaceLogin(); Swal.fire('‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤', err.message, 'error'); }
            } else {
                closeFaceLogin();
                Swal.fire('‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', res.message, 'error');
            }
        });
    }
  }

  let faceModelsLoaded = false;
  let labeledFaceDescriptors = null;
  async function loadFaceModels() {
      const MODEL_URL = 'https://cdn.jsdelivr.net/gh/cgarciagl/face-api.js@0.22.2/weights/';
      try {
          await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
          await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
          await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
          faceModelsLoaded = true;
          var btn = document.getElementById('btnFaceLogin');
          btn.disabled = false; btn.innerHTML = '<i class="bi bi-person-bounding-box"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤';
      } catch (e) { var btn = document.getElementById('btnFaceLogin'); btn.innerHTML = '‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î AI ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; }
  }
  async function prepareReferenceFace(base64Image, name) {
    const img = await faceapi.fetchImage(base64Image);
    const detections = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
    if (!detections) throw new Error("‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏≤‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠");
    labeledFaceDescriptors = new faceapi.LabeledFaceDescriptors(name, [detections.descriptor]);
  }
  async function startFaceCamera(empId, empName, empPhoto, allowedApps, sysConfig) {
    const video = document.getElementById('faceVideo');
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
        video.srcObject = stream;
        video.onplay = () => {
            document.getElementById('faceStatus').innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á...';
            const canvas = document.getElementById('faceCanvas');
            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);
            const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.55);
            const interval = setInterval(async () => {
                if (!video.paused && !video.ended) {
                    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);
                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                    if (resizedDetections.length > 0) {
                        const bestMatch = faceMatcher.findBestMatch(resizedDetections[0].descriptor);
                        if (bestMatch.label !== 'unknown') {
                            clearInterval(interval); 
                            closeFaceLogin(); 
                            performLoginSuccess(empId, empName, empPhoto, allowedApps, sysConfig); 
                        }
                    }
                }
            }, 500);
            video.dataset.intervalId = interval;
            // *** ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ ***
            isFaceMatched = false;
            eyesOpenDetected = false; // Reset ‡∏Ñ‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ï‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
            isScanning = true;
            matchCounter = 0; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö
            isScanning = true;
            detectFaceLoop();
        };
    } catch (err) { Swal.fire('Camera Error', err.message, 'error'); closeFaceLogin(); }
  }
  function closeFaceLogin() {
    const video = document.getElementById('faceVideo');
    if (video.srcObject) { video.srcObject.getTracks().forEach(t => t.stop()); }
    if (video.dataset.intervalId) clearInterval(video.dataset.intervalId);
    document.getElementById('faceLoginModal').classList.add('hidden');
  }

function performLoginSuccess(empId, name, photo, allowedApps, sysConfig) {
    // ‡πÅ‡∏™‡∏î‡∏á Loading ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

    var data = { 
        action: 'registerDevice', 
        empId: empId, 
        deviceToken: getDeviceToken(), 
        os: getMobileOS() 
    };

    // FIXED: Use callAPI
    callAPI(data, function(res) {
        
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (Force Setup)
        if (res.status === 'force_setup') {
            Swal.close();
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
            document.getElementById('setupEmpId').value = res.empId;
            document.getElementById('setupShowName').innerText = res.name;
            document.getElementById('setupShowId').innerText = res.empId;
            
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Setup
            hideAll();
            document.getElementById('setupPassScreen').classList.remove('hidden');
            
            Swal.fire({ 
                icon: 'info', 
                title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö', 
                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ' 
            });
        } 
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥ (Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)
        else {
            Swal.fire({ 
                icon: 'success', 
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 
                text: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ' + name, 
                timer: 1500, 
                showConfirmButton: false 
            }).then(() => { 
                if (pendingBroadcastData.msg && pendingBroadcastData.msg.toString().trim() !== "") {
                    showBroadcast(pendingBroadcastData.msg, function() {
                        loginSuccess(empId, name, photo, allowedApps, sysConfig);
                        pendingBroadcastData = { msg: null, token: null, name: null, photo: null, allowedApps: null, sysConfig: null }; 
                    });
                } else {
                    loginSuccess(empId, name, photo, allowedApps, sysConfig);
                }
            });
        }
    });
}

  function showBroadcast(message, callback) {
      Swal.fire({
          title: 'üì¢ <strong>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</strong>',
          html: '<div style="text-align: left; font-size: 1rem;">' + message + '</div>',
          icon: 'info',
          confirmButtonText: '<i class="bi bi-check-lg"></i> ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö',
          confirmButtonColor: '#0d6efd',
          backdrop: `rgba(0,0,123,0.4)`,
          allowOutsideClick: false,
          allowEscapeKey: false
      }).then((result) => {
          if (result.isConfirmed) {
              if (callback) callback();
          }
      });
  }

  function doSubmitNewPassword() {
      var empId = document.getElementById('setupEmpId').value;
      var p1 = document.getElementById('newPass').value;
      var p2 = document.getElementById('confirmPass').value;

      if(!p1 || !p2) { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', 'warning'); return; }
      if(p1 !== p2) { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô', 'error'); return; }
      
      var data = { action: 'setPassword', empId: empId, newPass: p1, deviceToken: getDeviceToken(), os: getMobileOS() };
      callAPI(data, function(res) {
          if(res.status === 'success') {
              Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á' }).then((result) => { showLogin(); document.getElementById('loginInput').value = empId; document.getElementById('loginPass').value = ''; document.getElementById('loginPass').focus(); });
          } else { Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.message, 'error'); }
      });
  }
  function getLocalDateString() { var d = new Date(); var year = d.getFullYear(); var month = ('0' + (d.getMonth() + 1)).slice(-2); var day = ('0' + d.getDate()).slice(-2); return year + '-' + month + '-' + day; }
  function hideAll() { document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('registerScreen').classList.add('hidden'); document.getElementById('otpScreen').classList.add('hidden'); document.getElementById('dashboardScreen').classList.add('hidden'); document.getElementById('setupPassScreen').classList.add('hidden'); }
  function showLogin() { hideAll(); document.getElementById('loginScreen').classList.remove('hidden'); }
  function showRegister() { hideAll(); document.getElementById('registerScreen').classList.remove('hidden'); loadDepartments(); }
  function showOTP() { hideAll(); document.getElementById('otpScreen').classList.remove('hidden'); }
  function doLogout() { currentUser = null; if (watchId) navigator.geolocation.clearWatch(watchId); showLogin(); }
  
  function loadDepartments() { 
      callAPI({ action: 'getDepartments' }, function(res) { 
          if (res.status === 'success') { 
              var select = document.getElementById('regDept'); 
              select.innerHTML = '<option value="" selected disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>'; 
              res.data.forEach(function(dept) { 
                  var option = document.createElement('option'); option.value = dept; option.text = dept; select.appendChild(option); 
              }); 
          } 
      }); 
  }
  function validatePassword(pass) { return /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[\W_]).{8,}$/.test(pass); }
  function doRegister() { 
      var empId = document.getElementById('regEmpId').value; var fname = document.getElementById('regFname').value; var lname = document.getElementById('regLname').value; var dept = document.getElementById('regDept').value; var email = document.getElementById('regEmail').value; var pass = document.getElementById('regPass').value; var confirmPass = document.getElementById('regConfirmPass').value; 
      if (!empId || !fname || !lname || !dept || !email || !pass || !confirmPass) { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning'); return; } 
      if (pass !== confirmPass) { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô', 'error'); return; } 
      var data = { action: 'register', empId: empId, fname: fname, lname: lname, department: dept, email: email, password: pass }; tempEmail = data.email; 
      callAPI(data, function(res) { if(res.status === 'success') { Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', res.message, 'success'); showOTP(); } else { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', res.message, 'error'); } }); 
  }
  function doConfirmOTP() { callAPI({ action: 'confirmOTP', email: tempEmail, otp: document.getElementById('otpInput').value }, function(res) { if(res.status === 'success') { Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success'); showLogin(); } else { Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.message, 'error'); } }); }
  
  // --- Auto Face Scan Logic ---

  function openCamera() { 
      if (!isLocationValid) { return; } 
      // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥ ***
      document.getElementById('btnScan').classList.add('hidden');

      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏ñ‡∏µ‡πà (Logic ‡πÄ‡∏î‡∏¥‡∏°)
      if (lastScanTime) { 
          var now = new Date(); 
          var last = new Date(); 
          var parts = lastScanTime.split(':'); 
          last.setHours(parseInt(parts[0]), parseInt(parts[1]), parseInt(parts[2]), 0); 
          var diffHrs = (now - last) / (1000 * 60 * 60); 
          if (diffHrs < 2 && diffHrs >= 0) { 
              var waitMins = Math.ceil((2 - diffHrs) * 60); 
              Swal.fire({ icon: 'warning', title: '‡∏™‡πÅ‡∏Å‡∏ô‡∏ñ‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ', html: '‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á 2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á<br>‡∏£‡∏≠‡∏≠‡∏µ‡∏Å ' + waitMins + ' ‡∏ô‡∏≤‡∏ó‡∏µ' }); 
              return; 
          } 
      } 

      // ‡πÄ‡∏õ‡∏¥‡∏î Modal
      var modal = document.getElementById('cameraModal'); 
      var video = document.getElementById('videoFeed'); 
      modal.classList.remove('hidden'); 
      modal.style.display = 'flex'; 
      
      document.getElementById('scanStatusText').innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á...";
      document.getElementById('scanStatusBox').classList.remove('bg-success', 'text-white');
      document.getElementById('scanStatusBox').classList.add('bg-white');

      // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
      navigator.mediaDevices.getUserMedia({ 
          audio: false, 
          video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } } 
      }).then(function(stream) { 
          video.srcObject = stream;
          video.onplay = function() {
              // ‡πÄ‡∏£‡∏¥‡πà‡∏° Loop ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤
              isScanning = true;
              detectFaceLoop();
          };
      }).catch(function(err) { 
          Swal.fire('Camera Error', err.message, 'error'); 
          closeCamera(); 
      }); 
  }
 

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£ Match ‡∏´‡∏ô‡πâ‡∏≤
  // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏à‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß
  //var isFaceMatched = false;
  //var eyesOpenDetected = false; // *** ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ï‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á ***
/*
async function detectFaceLoop() {
      if (!isScanning) return;
      
      const video = document.getElementById('videoFeed');
      const canvas = document.getElementById('scanOverlay');
      
      // 1. Setup Canvas
      const elementWidth = video.clientWidth;
      const elementHeight = video.clientHeight;
      canvas.width = elementWidth;
      canvas.height = elementHeight;

      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // ‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô Canvas ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏£‡∏∞‡∏à‡∏Å
      ctx.save();
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);

      // 2. ‡∏ß‡∏≤‡∏î‡πÄ‡∏Ñ‡πâ‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏´‡∏ô‡πâ‡∏≤ (Face Guide) ‡∏£‡∏≠‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô (‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß = Default)
      let guideColor = 'white'; 
      let guideStatusText = "‡∏ß‡∏≤‡∏á‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö";
      let progressVal = 0;

      // ‡∏ß‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á Guide
      const guideArea = drawFaceGuide(ctx, elementWidth, elementHeight, 'white'); 

      // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Scale ‡πÄ‡∏û‡∏∑‡πà‡∏≠ mapping ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Å‡∏±‡∏ö‡∏à‡∏≠
      const videoWidth = video.videoWidth;
      const videoHeight = video.videoHeight;
      const scale = Math.min(elementWidth / videoWidth, elementHeight / videoHeight);
      const displayWidth = videoWidth * scale;
      const displayHeight = videoHeight * scale;
      const offsetX = (elementWidth - displayWidth) / 2;
      const offsetY = (elementHeight - displayHeight) / 2;
      const displaySize = { width: displayWidth, height: displayHeight };

      const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                                     .withFaceLandmarks()
                                     .withFaceDescriptor();

      if (detection) {
          const resizedDetections = faceapi.resizeResults(detection, displaySize);
          const box = resizedDetections.detection.box;

          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏ô‡∏à‡∏≠ (Shifted Box)
          const faceCenterX = (box.x + offsetX) + (box.width / 2);
          const faceCenterY = (box.y + offsetY) + (box.height / 2);

          // 4. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ "‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á" ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á? (Distance Check)
          // ‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 60px
          const distToCenter = Math.sqrt(
              Math.pow(faceCenterX - guideArea.centerX, 2) + 
              Math.pow(faceCenterY - guideArea.centerY, 2)
          );

          const isCentered = distToCenter < 80; // ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏á‡πÅ‡∏°‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô (‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≠‡∏¢ = ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πä‡∏∞)

          if (isCentered) {
              
              // 5. ‡∏ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á -> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÑ‡∏´‡∏°
              if (!referenceFaceDescriptor) {
                   // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö (Auto Pass)
                   guideColor = '#ffc107';
                   guideStatusText = "Auto Snap...";
                   autoSnap(video);
                   ctx.restore(); return;
              }

              const faceMatcher = new faceapi.FaceMatcher(referenceFaceDescriptor, 0.55);
              const match = faceMatcher.findBestMatch(detection.descriptor);

              if (match.label !== 'unknown' && match.distance < 0.5) {
                  // *** ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á + ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ***
                  matchCounter++;
                  
                  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Progress
                  progressVal = Math.min((matchCounter / REQUIRED_MATCHES) * 100, 100);
                  
                  if (matchCounter >= REQUIRED_MATCHES) {
                      // Success
                      guideColor = '#198754'; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                      guideStatusText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
                      
                      // ‡∏ß‡∏≤‡∏î‡∏ó‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                      ctx.clearRect(0, 0, canvas.width, canvas.height);
                      drawFaceGuide(ctx, elementWidth, elementHeight, guideColor, 100);
                      
                      document.getElementById('scanStatusText').innerText = guideStatusText;
                      document.getElementById('scanStatusBox').classList.remove('bg-white', 'bg-primary');
                      document.getElementById('scanStatusBox').classList.add('bg-success', 'text-white');

                      isScanning = false;
                      autoSnap(video);
                      ctx.restore(); return;

                  } else {
                      // Counting
                      guideColor = '#0d6efd'; // ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô
                      guideStatusText = `‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏¥‡πà‡∏á‡πÜ... ${Math.floor(progressVal)}%`;
                  }

              } else {
                  // *** ‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á (Wrong Person) ***
                  matchCounter = 0;
                  guideColor = '#dc3545'; // ‡πÅ‡∏î‡∏á
                  guideStatusText = "‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
              }

          } else {
              // *** ‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á ***
              matchCounter = 0;
              guideColor = 'white'; // ‡∏Ç‡∏≤‡∏ß (‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏±‡∏ö)
              guideStatusText = "‡∏Ç‡∏¢‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏£‡∏≠‡∏ö";
          }

      } else {
          // ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏´‡∏ô‡πâ‡∏≤
          matchCounter = 0;
          guideColor = 'white';
          guideStatusText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á";
      }

      // ‡∏ß‡∏≤‡∏î Guide ‡∏ó‡∏±‡∏ö‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏™‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawFaceGuide(ctx, elementWidth, elementHeight, guideColor, progressVal);

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
      document.getElementById('scanStatusText').innerText = guideStatusText;
      
      // ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
      const statusBox = document.getElementById('scanStatusBox');
      statusBox.className = "px-4 py-2 rounded-pill shadow-sm d-inline-block"; // Reset class
      if (guideColor === '#dc3545') { statusBox.classList.add('bg-danger', 'text-white'); }
      else if (guideColor === '#0d6efd') { statusBox.classList.add('bg-primary', 'text-white'); }
      else if (guideColor === '#198754') { statusBox.classList.add('bg-success', 'text-white'); }
      else { statusBox.classList.add('bg-white', 'text-dark'); }

      ctx.restore(); // Restore Mirror Effect
      
      setTimeout(detectFaceLoop, 100);
  }
 */
  async function detectFaceLoop() {
      if (!isScanning) return;
      
      const video = document.getElementById('videoFeed');
      const canvas = document.getElementById('scanOverlay');
      
      // 1. Setup Canvas & Scale
      const videoWidth = video.videoWidth;
      const videoHeight = video.videoHeight;
      const elementWidth = video.clientWidth;
      const elementHeight = video.clientHeight;

      const scale = Math.min(elementWidth / videoWidth, elementHeight / videoHeight);
      const displayWidth = videoWidth * scale;
      const displayHeight = videoHeight * scale;
      const offsetX = (elementWidth - displayWidth) / 2;
      const offsetY = (elementHeight - displayHeight) / 2;
      const displaySize = { width: displayWidth, height: displayHeight };

      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Canvas
      canvas.width = elementWidth;
      canvas.height = elementHeight;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // ‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô Canvas (Mirror)
      ctx.save();
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);

      // ‡∏ß‡∏≤‡∏î Guide ‡∏£‡∏≠‡πÑ‡∏ß‡πâ
      let guideColor = 'white'; 
      let guideStatusText = "‡∏ß‡∏≤‡∏á‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö";
      let progressVal = 0;
      const guideArea = drawFaceGuide(ctx, elementWidth, elementHeight, 'white'); 

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤
      const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                                     .withFaceLandmarks()
                                     .withFaceDescriptor();

      if (detection) {
          const resizedDetections = faceapi.resizeResults(detection, displaySize);
          const box = resizedDetections.detection.box;

          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤ (Shift)
          const faceCenterX = (box.x + offsetX) + (box.width / 2);
          const faceCenterY = (box.y + offsetY) + (box.height / 2);

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÑ‡∏´‡∏°
          const distToCenter = Math.sqrt(
              Math.pow(faceCenterX - guideArea.centerX, 2) + 
              Math.pow(faceCenterY - guideArea.centerY, 2)
          );
          const isCentered = distToCenter < 80; 

          if (isCentered) {
              
              // *** ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ -> ‡∏´‡πâ‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô ***
              if (!referenceFaceDescriptor) {
                   // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á
                   guideColor = '#dc3545';
                   // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin
                   guideStatusText = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin)";
                   
                   // *** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏≠‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î autoSnap(video) ‡∏≠‡∏≠‡∏Å ***
                   
                   // ‡∏ß‡∏≤‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡πÅ‡∏î‡∏á) ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
                   drawFaceGuide(ctx, elementWidth, elementHeight, guideColor);
                   document.getElementById('scanStatusText').innerText = guideStatusText;
                   
                   const statusBox = document.getElementById('scanStatusBox');
                   statusBox.className = "px-4 py-2 rounded-pill shadow-sm d-inline-block bg-danger text-white";
                   
                   ctx.restore(); 
                   // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ï‡πà‡∏≠ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏î‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ) ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                   setTimeout(detectFaceLoop, 100); 
                   return;
              }

              // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö -> ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≠
              const faceMatcher = new faceapi.FaceMatcher(referenceFaceDescriptor, 0.55);
              const match = faceMatcher.findBestMatch(detection.descriptor);

              if (match.label !== 'unknown' && match.distance < 0.5) {
                  // ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á + ‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏ô -> ‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
                  matchCounter++;
                  progressVal = Math.min((matchCounter / REQUIRED_MATCHES) * 100, 100);
                  
                  if (matchCounter >= REQUIRED_MATCHES) {
                      // Success
                      guideColor = '#198754'; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                      guideStatusText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
                      
                      // ‡∏ß‡∏≤‡∏î‡∏ó‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                      ctx.clearRect(0, 0, canvas.width, canvas.height);
                      drawFaceGuide(ctx, elementWidth, elementHeight, guideColor, 100);
                      
                      document.getElementById('scanStatusText').innerText = guideStatusText;
                      document.getElementById('scanStatusBox').className = "px-4 py-2 rounded-pill shadow-sm d-inline-block bg-success text-white";

                      isScanning = false;
                      autoSnap(video);
                      ctx.restore(); return;

                  } else {
                      // Counting
                      guideColor = '#0d6efd'; // ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô
                      guideStatusText = `‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏¥‡πà‡∏á‡πÜ... ${Math.floor(progressVal)}%`;
                  }

              } else {
                  // ‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á (Wrong Person)
                  matchCounter = 0;
                  guideColor = '#dc3545'; // ‡πÅ‡∏î‡∏á
                  guideStatusText = "‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
              }

          } else {
              // ‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á
              matchCounter = 0;
              guideColor = 'white'; 
              guideStatusText = "‡∏Ç‡∏¢‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏£‡∏≠‡∏ö";
          }

      } else {
          // ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏´‡∏ô‡πâ‡∏≤
          matchCounter = 0;
          guideColor = 'white';
          guideStatusText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á";
      }

      // ‡∏ß‡∏≤‡∏î Guide
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawFaceGuide(ctx, elementWidth, elementHeight, guideColor, progressVal);

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Text
      document.getElementById('scanStatusText').innerText = guideStatusText;
      
      const statusBox = document.getElementById('scanStatusBox');
      statusBox.className = "px-4 py-2 rounded-pill shadow-sm d-inline-block"; 
      if (guideColor === '#dc3545') statusBox.classList.add('bg-danger', 'text-white');
      else if (guideColor === '#0d6efd') statusBox.classList.add('bg-primary', 'text-white');
      else if (guideColor === '#198754') statusBox.classList.add('bg-success', 'text-white');
      else statusBox.classList.add('bg-white', 'text-dark');

      ctx.restore(); 
      setTimeout(detectFaceLoop, 100);
  }
  // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Progress
  function drawBox(ctx, box, color, text) {
      ctx.strokeStyle = color;
      ctx.lineWidth = 4;
      
      // ‡∏ß‡∏≤‡∏î‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°
      ctx.beginPath();
      ctx.rect(box.x, box.y, box.width, box.height);
      ctx.stroke();

      // ‡∏ß‡∏≤‡∏î‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
      if (text) {
          ctx.fillStyle = color;
          ctx.fillRect(box.x, box.y - 30, box.width, 30);
          ctx.fillStyle = "white";
          ctx.font = "bold 18px Kanit";
          ctx.textAlign = "center";
          ctx.fillText(text, box.x + (box.width/2), box.y - 8);
      }
  }
  // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Progress
  function drawBox(ctx, box, color, text) {
      ctx.strokeStyle = color;
      ctx.lineWidth = 4;
      
      // ‡∏ß‡∏≤‡∏î‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°
      ctx.beginPath();
      ctx.rect(box.x, box.y, box.width, box.height);
      ctx.stroke();

      // ‡∏ß‡∏≤‡∏î‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
      if (text) {
          ctx.fillStyle = color;
          ctx.fillRect(box.x, box.y - 30, box.width, 30);
          ctx.fillStyle = "white";
          ctx.font = "bold 18px Kanit";
          ctx.textAlign = "center";
          ctx.fillText(text, box.x + (box.width/2), box.y - 8);
      }
  }
  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö
  function drawBox(ctx, box, color, text) {
      ctx.strokeStyle = color;
      ctx.lineWidth = 4;
      ctx.strokeRect(box.x, box.y, box.width, box.height);
  }

  function autoSnap(video) {
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
      var canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      var ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      var imageBase64 = canvas.toDataURL('image/jpeg', 0.8);
      
      // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 1: ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ true ‡πÑ‡∏õ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏ï‡πà‡∏≠) ***
      closeCamera(true);
      
      // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 2: ‡∏Ç‡∏∂‡πâ‡∏ô Loading ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô User ‡∏Å‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠ GPS ***
      Swal.fire({ 
          title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', 
          text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏´‡πâ‡∏≤‡∏°‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á',
          allowOutsideClick: false, 
          didOpen: () => { Swal.showLoading() } 
      });

      // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      sendScanData(imageBase64);
  }

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° parameter isAutoSnap = false ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  function closeCamera(isAutoSnap = false) { 
      isScanning = false;
      var video = document.getElementById('videoFeed'); 
      if (video.srcObject) { 
          video.srcObject.getTracks().forEach(t => t.stop()); 
          video.srcObject = null; 
      } 
      document.getElementById('cameraModal').style.display = 'none'; 
      
      // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏™‡πÅ‡∏Å‡∏ô‡∏ú‡πà‡∏≤‡∏ô (Auto) ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å checkScanAvailability) ***
      // ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô loadHistory() ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ï‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢
      if (!isAutoSnap) {
          checkScanAvailability(); 
      }
  }

  function snapPhoto() { var video = document.getElementById('videoFeed'); if (!video.srcObject) return; Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } }); var canvas = document.createElement('canvas'); var ctx = canvas.getContext('2d'); var maxWidth = 800; var scale = maxWidth / video.videoWidth; canvas.width = maxWidth; canvas.height = video.videoHeight * scale; ctx.drawImage(video, 0, 0, canvas.width, canvas.height); var imageBase64 = canvas.toDataURL('image/jpeg', 0.8); closeCamera(); sendScanData(imageBase64); }
  function closeCamera() { var video = document.getElementById('videoFeed'); if (video.srcObject) { video.srcObject.getTracks().forEach(t => t.stop()); video.srcObject = null; } document.getElementById('cameraModal').style.display = 'none'; }
  function sendScanData(imageBase64) { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(function(position) { var data = { action: 'scan', empId: currentUser, clientDate: getLocalDateString(), lat: position.coords.latitude, lng: position.coords.longitude, imageBase64: imageBase64 }; callAPI(data, function(res) { Swal.close(); if(res.status === 'success') { Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏ß‡∏•‡∏≤: ' + res.time, 'success'); loadHistory(); } else { Swal.fire('Error', res.message, 'error'); } }); }, function(error) { Swal.fire('Location Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS', 'error'); }); } else { Swal.fire('Error', 'Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS', 'error'); } }

  // --- DASHBOARD LOGIC ---
  var mainChart = null; 
  var subCharts = [];
  var baseColors = ['#81C784', '#64B5F6', '#BA68C8', '#FFD54F', '#FF8A65', '#A1887F'];

  function loadStats() {
      var date = document.getElementById('statsDate').value;
      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
      
      // FIXED: Use callAPI
      callAPI({ action: 'getStats', date: date }, function(res){
          Swal.close();
          if(res.status === 'success') { 
              renderDashboard(res.logs, res.totalStats); 
          } else { 
              Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', res.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'warning'); 
          }
      });
  }

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ Dashboard (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)
  function clearDashboard() {
      // 1. ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏° (Main Chart)
      if (mainChart) { 
          mainChart.destroy(); 
          mainChart = null; 
      }
      
      // 2. ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á
      document.getElementById('centerTotalDisplay').innerHTML = 
          '<span class="text-muted small">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span>';

      // 3. ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡πà‡∏≠‡∏¢ (Sub Charts)
      document.getElementById('subChartsArea').innerHTML = 
          '<div class="col-12 text-center text-muted mt-5 pt-4">' +
          '<i class="bi bi-search display-1 text-secondary opacity-25"></i>' +
          '<p class="mt-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <b>"‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</p>' +
          '</div>';
  }

  function renderDashboard(logs, totalStats) {
      // 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      var areaStats = {}; 
      var processedEmps = new Set();
      var deptCounts = {}; 
      
      var grandTotalEmp = 0;
      var areaTotalEmp = {}; 

      if (totalStats) {
          for (var area in totalStats) {
              var deptObj = totalStats[area];
              var sumArea = 0;
              for (var d in deptObj) { sumArea += deptObj[d]; }
              areaTotalEmp[area] = sumArea; 
              grandTotalEmp += sumArea;
          }
      }

      logs.forEach(function(log) {
          if (!processedEmps.has(log.empId)) {
              processedEmps.add(log.empId);
              var area = log.area || 'Unknown';
              var dept = log.dept || 'Unknown';
              
              if (!areaStats[area]) areaStats[area] = 0; areaStats[area]++;
              if (!deptCounts[area]) deptCounts[area] = {};
              if (!deptCounts[area][dept]) deptCounts[area][dept] = 0;
              deptCounts[area][dept]++;
          }
      });

      // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
      var mainColorClass = (processedEmps.size < grandTotalEmp) ? 'text-danger' : 'text-success';
      document.getElementById('centerTotalDisplay').innerHTML = 
          `<span class="${mainColorClass}" style="font-size:2.2rem;">${processedEmps.size}</span>` + 
          `<span class="text-muted" style="font-size:1rem; font-weight:normal;"> / ${grandTotalEmp}</span>`;

      // 3. ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏°
      var ctx = document.getElementById('mainAreaChart').getContext('2d');
      if (mainChart) mainChart.destroy();
      
      // ‡πÄ‡∏ä‡πá‡∏Ñ Library
      if (typeof ChartDataLabels !== 'undefined') Chart.register(ChartDataLabels);

      mainChart = new Chart(ctx, {
          type: 'doughnut',
          data: { 
              labels: Object.keys(areaStats), 
              datasets: [{ 
                  data: Object.values(areaStats), 
                  backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#6610f2', '#20c997', '#fd7e14'],
                  borderWidth: 0
              }] 
          },
          options: { 
              responsive: true, maintainAspectRatio: false, cutout: '65%', layout: { padding: 20 },
              plugins: { 
                  legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20, font: { family: 'Kanit' } } },
                  datalabels: {
                      backgroundColor: 'rgba(255,255,255,0.9)', 
                      borderRadius: 6, padding: 6,
                      font: { size: 11, weight: 'bold', family: 'Kanit' },
                      textAlign: 'center',
                      
                      // *** 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠: ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (X < Y) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á ***
                      color: function(context) {
                          var label = context.chart.data.labels[context.dataIndex];
                          var value = context.dataset.data[context.dataIndex];
                          var total = areaTotalEmp[label] || value;
                          // ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° -> ‡∏™‡∏µ‡πÅ‡∏î‡∏á, ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö -> ‡∏™‡∏µ‡∏î‡∏≥
                          return (value < total) ? '#dc3545' : '#333';
                      },

                      formatter: function(value, context) {
                          var label = context.chart.data.labels[context.dataIndex];
                          var total = areaTotalEmp[label] || value; 
                          // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
                          return label + "\n" + value + " / " + total;
                      }
                  }
              } 
          }
      });

      renderSubCharts(deptCounts, totalStats);
  }
  function renderSubCharts(presentCounts, totalStats) {
      var container = document.getElementById('subChartsArea');
      container.innerHTML = ''; 
      
      Object.keys(presentCounts).forEach(function(area, index) {
          var deptsPresent = presentCounts[area];
          var deptsTotal = (totalStats && totalStats[area]) ? totalStats[area] : {};
          
          var originalLabels = Object.keys(deptsPresent);
          var dataPresent = Object.values(deptsPresent);
          
          var dynamicColors = [];     
          var displayLabels = [];     
          var dataTotalForLabel = []; 

          originalLabels.forEach(function(deptName, i) {
              var val = dataPresent[i];
              var total = deptsTotal[deptName] || val; 
              dataTotalForLabel.push(total);

              if (val >= total && total > 0) {
                  dynamicColors.push('#198754'); 
                  displayLabels.push('‚úÖ ' + deptName); 
              } else {
                  dynamicColors.push('#dc3545'); 
                  displayLabels.push('‚ö†Ô∏è ' + deptName);
              }
          });

          var areaTotalEmp = 0;
          for(var k in deptsTotal) areaTotalEmp += deptsTotal[k];
          var areaPresentEmp = dataPresent.reduce((a, b) => a + b, 0);
          var headerColorClass = (areaPresentEmp < areaTotalEmp) ? 'text-danger' : 'text-success';

          var dynamicHeight = (originalLabels.length * 30) + 50; 

          var col = document.createElement('div');
          col.className = 'col-12 col-md-6';
          var canvasId = 'subChart_' + index;
          
          col.innerHTML = `
            <div class="card-sub h-100">
                <div class="d-flex justify-content-between border-bottom pb-2 mb-2 align-items-center">
                    <span class="fw-bold text-primary text-truncate" style="max-width: 60%;" title="${area}">${area}</span>
                    <span class="badge bg-light text-dark border">
                        <span class="${headerColorClass} fw-bold" style="font-size:1.1em;">${areaPresentEmp}</span> 
                        <span class="text-muted small">/ ${areaTotalEmp} ‡∏Ñ‡∏ô</span>
                    </span>
                </div>
                <div style="height: ${dynamicHeight}px;">
                    <canvas id="${canvasId}"></canvas>
                </div>
            </div>
          `;
          container.appendChild(col);

          new Chart(document.getElementById(canvasId), {
              type: 'bar',
              data: {
                  labels: displayLabels,
                  datasets: [{
                      label: '‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô',
                      data: dataPresent,
                      backgroundColor: dynamicColors, 
                      barThickness: 24, borderRadius: 4
                  }]
              },
              options: {
                  indexAxis: 'y', responsive: true, maintainAspectRatio: false, 
                  plugins: { 
                      legend: { display: false },
                      tooltip: {
                          callbacks: {
                              label: function(context) {
                                  var idx = context.dataIndex;
                                  var val = context.parsed.x;
                                  var total = dataTotalForLabel[idx];
                                  return '‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: ' + val + ' / ' + total + ' ‡∏Ñ‡∏ô';
                              }
                          }
                      },
                      datalabels: {
                          anchor: 'end', align: 'end', font: {size:11, weight:'bold'},
                          color: function(context) { return context.dataset.backgroundColor[context.dataIndex]; },
                          
                          // *** 2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•: ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏Ñ‡∏£‡∏ö (X=Y) ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà Y ***
                          formatter: function(value, context) {
                              var idx = context.dataIndex;
                              var total = dataTotalForLabel[idx];
                              
                              if (value === total) {
                                  return total; // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡πÄ‡∏ä‡πà‡∏ô "5")
                              } else {
                                  return value + " / " + total; // ‡πÅ‡∏™‡∏î‡∏á "3 / 5"
                              }
                          }
                      }
                  },
                  scales: { 
                      x: { beginAtZero: true, grid: {display:false}, ticks: { display: false } },
                      y: { grid: {display:false}, ticks: { autoSkip: false, font: { size: 12 } } }
                  }
              }
          });
      });
  }
  
  // --- USER MANAGEMENT LOGIC (Updated V.2) ---
  var userModal = null;
  var allUsersData = [];

  // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
  function loadUserList() {
      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
      
      // FIXED: Use callAPI
      callAPI({ action: 'getAllUsers' }, function(res){
          Swal.close();
          if(res.status === 'success') {
              allUsersData = res.data;
              updateDeptDropdown(allUsersData); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dropdown ‡πÅ‡∏ú‡∏ô‡∏Å (‡∏ó‡∏±‡πâ‡∏á Search ‡πÅ‡∏•‡∏∞ Modal)
              renderUserTable(allUsersData);
          } else {
              Swal.fire('Error', res.message, 'error');
          }
      });
  }

  // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
  function renderUserTable(users) {
      var tbody = document.getElementById('userTableBody');
      tbody.innerHTML = '';
      
      if(users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-5">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
          return;
      }

      users.forEach(u => {
          var tr = document.createElement('tr');
          
          var photoHtml = u.photoId ? 
              `<img src="https://drive.google.com/thumbnail?id=${u.photoId}&sz=s100" class="rounded-circle border" style="width:38px; height:38px; object-fit:cover;">` : 
              `<div class="rounded-circle bg-light border d-flex align-items-center justify-content-center" style="width:38px; height:38px;"><i class="bi bi-person text-secondary"></i></div>`;

          var statusBadge = (u.status === 'Active') ? '<span class="badge bg-success">‡∏õ‡∏Å‡∏ï‡∏¥</span>' : 
                            (u.status === 'Inactive') ? '<span class="badge bg-danger">‡∏≠‡∏≠‡∏Å</span>' : '<span class="badge bg-secondary">'+u.status+'</span>';

          tr.innerHTML = `
              <td class="text-center">${photoHtml}</td>
              <td>
                  <div class="fw-bold text-dark" style="font-size: 0.9rem;">${u.fname} ${u.lname}</div>
                  <div class="d-flex align-items-center"><span class="badge bg-light text-dark border me-1">${u.empId}</span></div>
                  <div class="text-primary fst-italic small">${u.dept}</div>
              </td>
              <td class="text-center">${statusBadge}</td>
              <td class="text-center">
                  <button class="btn btn-sm btn-outline-secondary rounded-circle" onclick="openUserModal('edit', '${u.empId}')"><i class="bi bi-pencil-fill"></i></button>
              </td>
          `;
          tbody.appendChild(tr);
      });
  }

  // 3. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (Search + Filter Dept) *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ç‡πâ‡∏≠ 2 ***
  /*
  function filterUserTable() {
      var txt = document.getElementById('searchUser').value.toLowerCase().trim();
      var deptFilter = document.getElementById('filterDept').value; // ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Dropdown

      var filtered = allUsersData.filter(u => {
          var matchText = (String(u.empId).toLowerCase().includes(txt) || String(u.fname).toLowerCase().includes(txt));
          var matchDept = (deptFilter === "" || u.dept === deptFilter);
          return matchText && matchDept;
      });
      renderUserTable(filtered);
  }

  */ 
  // 3. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (Search + Filter Dept) *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏ú‡∏ô‡∏Å ***
  function filterUserTable() {
      var txt = document.getElementById('searchUser').value.toLowerCase().trim();
      var deptFilter = document.getElementById('filterDept').value; // ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Dropdown (‡πÄ‡∏õ‡πá‡∏ô String ‡πÄ‡∏™‡∏°‡∏≠)

      var filtered = allUsersData.filter(u => {
          // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Text
          var matchText = (String(u.empId).toLowerCase().includes(txt) || String(u.fname).toLowerCase().includes(txt));
          
          // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å (‡πÅ‡∏õ‡∏•‡∏á u.dept ‡πÄ‡∏õ‡πá‡∏ô String ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö)
          var matchDept = (deptFilter === "" || String(u.dept) === deptFilter);
          
          return matchText && matchDept;
      });
      renderUserTable(filtered);
  }
  // 4. ‡πÄ‡∏õ‡∏¥‡∏î Modal (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
  function openUserModal(mode, empId) {
      if(!userModal) userModal = new bootstrap.Modal(document.getElementById('userFormModal'));
      document.getElementById('formMode').value = mode;
      
      // Reset Form
      document.getElementById('userForm').reset();
      document.getElementById('u_empId').readOnly = false;
      document.getElementById('editTools').classList.add('hidden'); 
      
      // Reset Image Preview
      document.getElementById('u_photoFile').value = '';
      document.getElementById('u_currentPhotoId').value = '';
      document.getElementById('u_previewImg').classList.add('hidden');
      document.getElementById('u_noImageText').classList.remove('hidden');

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á Checkbox ‡∏£‡∏∞‡∏ö‡∏ö (System List) *** ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå 1.2 ***
      renderSystemCheckboxes([]);

      if(mode === 'add') {
          document.getElementById('userModalTitle').innerHTML = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
          document.getElementById('u_status').value = 'Active';
      } else {
          document.getElementById('userModalTitle').innerHTML = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
          document.getElementById('editTools').classList.remove('hidden');
          document.getElementById('u_empId').readOnly = true; 
          
          var u = allUsersData.find(x => String(x.empId) === String(empId));
          if(u) {
              document.getElementById('u_empId').value = u.empId;
              document.getElementById('u_fname').value = u.fname;
              document.getElementById('u_lname').value = u.lname;
              document.getElementById('u_email').value = u.email;
              document.getElementById('u_dept').value = u.dept;
              document.getElementById('u_status').value = u.status;
              if(u.startDate) { /* ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà... */ }

              // Show Existing Image
              if(u.photoId) {
                  document.getElementById('u_currentPhotoId').value = u.photoId;
                  document.getElementById('u_previewImg').src = "https://drive.google.com/thumbnail?id=" + u.photoId + "&sz=s200";
                  document.getElementById('u_previewImg').classList.remove('hidden');
                  document.getElementById('u_noImageText').classList.add('hidden');
              }

              // Load User's Systems (‡∏à‡∏≤‡∏Å Code.gs ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á allowedSystems ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ô getAllUsers)
              // ‡∏™‡∏°‡∏°‡∏ï‡∏¥ u.allowedSystems ‡∏Ñ‡∏∑‡∏≠ "TA,DASHBOARD"
              var sysString = u.allowedSystems ? String(u.allowedSystems) : '';
              var userSystems = sysString.split(',').map(s => s.trim()); // ‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏≠‡∏Å
              
              renderSystemCheckboxes(userSystems);
          }
      }
      userModal.show();
  }

  // Helper: ‡∏™‡∏£‡πâ‡∏≤‡∏á Checkbox ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö
  function renderSystemCheckboxes(userSystems) {
      var container = document.getElementById('systemCheckboxContainer');
      container.innerHTML = '';
      
      // systemConfigList ‡∏Ñ‡∏∑‡∏≠ Global Variable ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      systemConfigList.forEach(sys => {
          var isChecked = userSystems.includes(sys.id) || userSystems.includes('All') ? 'checked' : '';
          var html = `
              <div class="form-check">
                  <input class="form-check-input system-check" type="checkbox" value="${sys.id}" id="sys_${sys.id}" ${isChecked}>
                  <label class="form-check-label small" for="sys_${sys.id}">
                      ${sys.name}
                  </label>
              </div>
          `;
          container.innerHTML += html;
      });
  }

  function toggleAllSystems() {
      var isAll = document.getElementById('chk_AllSystems').checked;
      var checkboxes = document.querySelectorAll('.system-check');
      checkboxes.forEach(cb => cb.checked = isAll);
  }

  // Helper: Preview Image *** ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå 1.1 ***
  function previewImage(input) {
      if (input.files && input.files[0]) {
          var reader = new FileReader();
          reader.onload = function(e) {
              document.getElementById('u_previewImg').src = e.target.result;
              document.getElementById('u_previewImg').classList.remove('hidden');
              document.getElementById('u_noImageText').classList.add('hidden');
          }
          reader.readAsDataURL(input.files[0]);
      }
  }

  // 5. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Save) *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ***
  function saveUser() {
      var empId = document.getElementById('u_empId').value.trim();
      var fname = document.getElementById('u_fname').value.trim();
      var dept = document.getElementById('u_dept').value;

      if(!empId || !fname || !dept) {
          Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning'); return;
      }

      // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Systems)
      var selectedSystems = [];
      if(document.getElementById('chk_AllSystems').checked) {
          selectedSystems.push('All');
      } else {
          document.querySelectorAll('.system-check:checked').forEach(cb => {
              selectedSystems.push(cb.value);
          });
      }

      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Object ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      var userObj = {
          action: 'saveUser',
          mode: document.getElementById('formMode').value,
          empId: empId,
          fname: fname,
          lname: document.getElementById('u_lname').value.trim(),
          email: document.getElementById('u_email').value.trim(),
          dept: dept,
          status: document.getElementById('u_status').value,
          startDate: document.getElementById('u_startDate').value,
          currentPhotoId: document.getElementById('u_currentPhotoId').value,
          allowedSystems: selectedSystems.join(',') // ‡πÅ‡∏õ‡∏•‡∏á Array ‡πÄ‡∏õ‡πá‡∏ô String "TA,DASHBOARD"
      };

      // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Base64)
      var fileInput = document.getElementById('u_photoFile');
      if (fileInput.files.length > 0) {
          var reader = new FileReader();
          reader.onload = function(e) {
              userObj.fileData = e.target.result; // Base64 String
              sendSaveRequest(userObj);
          };
          reader.readAsDataURL(fileInput.files[0]);
      } else {
          userObj.fileData = ""; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
          sendSaveRequest(userObj);
      }
  }

  function sendSaveRequest(data) {
      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() });
      
      // FIXED: Use callAPI
      callAPI(data, function(res){
          if(res.status==='success') { 
              Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1000, showConfirmButton: false });
              userModal.hide(); 
              loadUserList(); 
          } else { Swal.fire('Error', res.message, 'error'); }
      });
  }

  function resetUserField(type) {
      var empId = document.getElementById('u_empId').value;
      Swal.fire({ title: (type === 'password') ? '‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?' : '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á?', icon: 'warning', showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' }).then((result) => {
          if (result.isConfirmed) {
              callAPI({ action: 'resetField', empId: empId, field: type }, function(res){
                  if(res.status === 'success') Swal.fire('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', res.message, 'success');
                  else Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.message, 'error');
              });
          }
      });
  }

  function updateDeptDropdown(users) {
      var depts = new Set();
      users.forEach(u => { if(u.dept) depts.add(u.dept); });
      var sorted = Array.from(depts).sort();

      var selModal = document.getElementById('u_dept');
      var currentVal = selModal.value; 
      selModal.innerHTML = '<option value="" selected disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>';
      sorted.forEach(d => { 
          var opt = document.createElement('option'); opt.text = d; opt.value = d; selModal.add(opt); 
      });
      if(currentVal) selModal.value = currentVal;

      var selFilter = document.getElementById('filterDept');
      var currentFilter = selFilter.value;
      selFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>';
      sorted.forEach(d => {
          var opt = document.createElement('option'); opt.text = d; opt.value = d; selFilter.add(opt);
      });
      selFilter.value = currentFilter;
  }

  // --- BLINK DETECTION HELPERS (Liveness Check) ---
  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏î‡∏ß‡∏á‡∏ï‡∏≤ (Eye Aspect Ratio - EAR)
  function getEyeRatio(eyePoints) {
      // eyePoints 0-5 ‡∏Ñ‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏£‡∏≠‡∏ö‡∏î‡∏ß‡∏á‡∏ï‡∏≤
      // ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á (‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏ö‡∏ô-‡∏•‡πà‡∏≤‡∏á)
      const v1 = dist(eyePoints[1], eyePoints[5]);
      const v2 = dist(eyePoints[2], eyePoints[4]);
      
      // ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (‡∏´‡∏±‡∏ß‡∏ï‡∏≤-‡∏´‡∏≤‡∏á‡∏ï‡∏≤)
      const h = dist(eyePoints[0], eyePoints[3]);
      
      // ‡∏™‡∏π‡∏ï‡∏£ EAR
      const ratio = (v1 + v2) / (2.0 * h);
      return ratio;
  }

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏∏‡∏î 2 ‡∏à‡∏∏‡∏î
  function dist(p1, p2) {
      return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
  }
  
  // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡πÄ‡∏Ñ‡πâ‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏´‡∏ô‡πâ‡∏≤ (Face Guide Overlay) ---
 // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡πÄ‡∏Ñ‡πâ‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏´‡∏ô‡πâ‡∏≤ (Face Guide Overlay) ---
  function drawFaceGuide(ctx, width, height, color, progress = 0) {
      const centerX = width / 2;
      const centerY = height / 2;
      
      // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ß‡∏á‡∏£‡∏µ (‡∏£‡∏π‡∏õ‡πÑ‡∏Ç‡πà)
      const guideWidth = width * 0.55; 
      const guideHeight = guideWidth * 1.3; 

      ctx.save();
      
      // 1. ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (‡∏ß‡∏á‡∏£‡∏µ‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏á)
      ctx.beginPath();
      ctx.ellipse(centerX, centerY, guideWidth / 2, guideHeight / 2, 0, 0, 2 * Math.PI);
      ctx.lineWidth = 5;
      ctx.strokeStyle = color;
      
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞
      if (color === 'white' || color === '#ffffff') {
          ctx.setLineDash([10, 10]);
      } else {
          ctx.setLineDash([]); // ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏∂‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏à‡∏≠
      }
      ctx.stroke();

      // 2. ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô Progress ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏ß‡∏¥‡πà‡∏á‡∏ó‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏ß‡∏á‡∏£‡∏µ‡πÄ‡∏õ‡πä‡∏∞‡πÜ)
      if (progress > 0) {
          ctx.beginPath();
          ctx.setLineDash([]); // ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏∂‡∏ö‡πÄ‡∏™‡∏°‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Progress
          
          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà -90 ‡∏≠‡∏á‡∏®‡∏≤ (‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î)
          const startAngle = -0.5 * Math.PI;
          // ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡∏≤‡∏° % ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
          const endAngle = startAngle + (2 * Math.PI * (progress / 100));

          // ‡πÉ‡∏ä‡πâ ellipse (‡∏ß‡∏á‡∏£‡∏µ) ‡πÅ‡∏ó‡∏ô arc (‡∏ß‡∏á‡∏Å‡∏•‡∏°)
          ctx.ellipse(centerX, centerY, guideWidth / 2, guideHeight / 2, 0, startAngle, endAngle);
          
          ctx.lineWidth = 7; // ‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡πâ‡∏´‡∏ô‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏î‡∏π‡∏°‡∏µ‡∏°‡∏¥‡∏ï‡∏¥
          ctx.strokeStyle = '#198754'; // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
          ctx.lineCap = 'round'; // ‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô‡∏°‡∏ô‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
          ctx.stroke();
      }

      ctx.restore();
      
      // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡πÑ‡∏´‡∏°
      return { 
          x: centerX - guideWidth/2, 
          y: centerY - guideHeight/2, 
          width: guideWidth, 
          height: guideHeight,
          centerX: centerX,
          centerY: centerY
      };
  }

  // ==========================================
  // PAYSLIP LOGIC
  // ==========================================

  // --- 1. ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà Column ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å CSV ---
  const incomeKeys = ['‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏±‡∏ö', '‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ö‡πâ‡∏≤‡∏ô', '‡∏Ñ‡πà‡∏≤‡∏Å‡∏∞', '‡∏Ñ‡πà‡∏≤‡∏ù‡∏µ‡∏°‡∏∑‡∏≠', '‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏≠‡∏á‡∏ä‡∏µ‡∏û', '‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏¢‡∏±‡∏á‡∏ä‡∏µ‡∏û', '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÜ', '‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏Ç‡∏¢‡∏±‡∏ô', 'ot1 amt', 'ot15 amt', 'ot2 amt', 'ot3 amt'];
  const deductKeys = ['‡∏å‡∏≤‡∏õ‡∏ô‡∏Å‡∏¥‡∏à‡∏ç‡∏≤‡∏ï‡∏¥', '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°', '‡∏´‡∏±‡∏Å‡∏™‡∏≤‡∏¢', '‡∏†‡∏≤‡∏©‡∏µ'];

  // --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Navigation (openApp) ---
  // ‡∏ô‡∏≥ 'adminImportPayslipSection' ‡πÅ‡∏•‡∏∞ 'userPayslipSection' ‡πÑ‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô Array allSections ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô openApp ‡πÅ‡∏•‡∏∞ showPortal ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
  // ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç openApp ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö:
  /*
      else if (appId === 'PAYSLIP') {
          document.getElementById('userPayslipSection').classList.remove('hidden');
          loadPayslipPeriods();
      }
      else if (appId === 'IMPORT_PAYSLIP') {
          document.getElementById('adminImportPayslipSection').classList.remove('hidden');
      }
  */

  // --- 3. ‡∏ù‡∏±‡πà‡∏á Admin: ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á CSV ---
  function processPayslipCSV() {
      const fileInput = document.getElementById('csvFileInput');
      const period = document.getElementById('importPeriod').value.trim();

      if (!period) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏á‡∏ß‡∏î (‡πÄ‡∏ä‡πà‡∏ô 01/2568)', 'warning');
      if (!fileInput.files.length) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV', 'warning');

      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...', didOpen: () => Swal.showLoading() });

      Papa.parse(fileInput.files[0], {
          header: false, // ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ Array ‡πÅ‡∏ö‡∏ö index ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡πà‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤
          skipEmptyLines: true,
          complete: function(results) {
              const data = results.data;
              if (data.length < 2) return Swal.fire('Error', '‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');

              // Trim ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î (‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á)
              const cleanData = data.map(row => row.map(cell => String(cell).trim()));
              
              const payload = {
                  action: 'importPayslip',
                  period: period,
                  headers: cleanData[0],
                  records: cleanData.slice(1) // ‡∏ï‡∏±‡∏î Header ‡∏≠‡∏≠‡∏Å
              };

              Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Database...', didOpen: () => Swal.showLoading() });
              callAPI(payload, function(res) {
                  if (res.status === 'success') {
                      Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', res.message, 'success');
                      fileInput.value = '';
                  } else {
                      Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.message, 'error');
                  }
              });
          },
          error: function(err) { Swal.fire('‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', err.message, 'error'); }
      });
  }
  // --- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Payslip ---
  var currentPayslipEmpId = null;

  // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 1: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô openApp (‡∏ï‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏™‡∏°‡∏≠)
  function openApp(appId) {
      var appConfig = systemConfigList.find(s => s.id === appId);
      if (appConfig && (appConfig.type === 'External' || appId.startsWith('http'))) {
          window.open(appId, '_blank'); return; 
      }

      var allSections = ['portalSection', 'taAppSection', 'adminDashboardSection', 'adminVerifySection', 'adminUserSection', 'adminImportPayslipSection', 'userPayslipSection'];
      allSections.forEach(function(id) { var el = document.getElementById(id); if (el) el.classList.add('hidden'); });
      document.getElementById('btnBackToHome').classList.remove('hidden');

      if (appId === 'TA') {
          document.getElementById('taAppSection').classList.remove('hidden'); document.getElementById('historyDate').value = getLocalDateString(); loadHistory(); 
      } else if (appId === 'DASHBOARD') {
          document.getElementById('adminDashboardSection').classList.remove('hidden'); document.getElementById('statsDate').valueAsDate = new Date(); loadStats();
      } else if (appId === 'VERIFY') {
          document.getElementById('adminVerifySection').classList.remove('hidden'); loadDeptForVerify();
      } else if (appId === 'USERS') {
          document.getElementById('adminUserSection').classList.remove('hidden'); loadUserList();
      } else if (appId === 'PAYSLIP') {
          document.getElementById('userPayslipSection').classList.remove('hidden');
          // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏™‡∏°‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π
          currentPayslipEmpId = currentUser; 
          
          // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏´‡πâ‡∏ô‡∏≥‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà Login (currentUser) ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Input ‡πÄ‡∏•‡∏¢ ***
          if(document.getElementById('ps_searchEmpInput')) {
              document.getElementById('ps_searchEmpInput').value = currentUser;
          }
          
          loadPayslipPeriods();
      } else if (appId === 'IMPORT_PAYSLIP') {
          document.getElementById('adminImportPayslipSection').classList.remove('hidden');
      } else {
          Swal.fire('Info', '‡∏£‡∏∞‡∏ö‡∏ö ' + appId + ' ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤', 'info'); showPortal(); 
      }
  }

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ß‡πà‡∏ô‡∏Ç‡∏¢‡∏≤‡∏¢
  function searchPayslip() {
      let inputVal = document.getElementById('ps_searchEmpInput').value.trim();
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏£‡∏´‡∏±‡∏™‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (currentUser) ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ó‡∏ô
      if (!inputVal) {
          inputVal = currentUser;
          document.getElementById('ps_searchEmpInput').value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
      }
      currentPayslipEmpId = inputVal;
      loadPayslipPeriods();
  }

  // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 2: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô loadPayslipPeriods
  function loadPayslipPeriods() {
      if (!currentPayslipEmpId) currentPayslipEmpId = currentUser;

      const select = document.getElementById('payslipPeriodSelect');
      select.innerHTML = '<option value="" selected disabled>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>';
      document.getElementById('payslipCard').classList.remove('hidden');
      
      // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
      document.getElementById('ps_empNameDisplay').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
      document.getElementById('ps_incomeList').innerHTML = '';
      document.getElementById('ps_deductList').innerHTML = '';
      document.getElementById('ps_totalIncome').innerText = '0';
      document.getElementById('ps_totalDeduct').innerText = '0';
      document.getElementById('ps_netPay').innerText = '0';
      document.getElementById('ps_baseSalary').innerText = '-';

      // ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô (‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ Server ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ Admin)
      document.getElementById('ps_empNo_text').style.display = 'inline-block';
      document.getElementById('ps_empNo_text').innerText = currentPayslipEmpId;
      document.getElementById('ps_empNo_input_group').style.display = 'none';

      // *** ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå requesterId: currentUser ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ***
      callAPI({ action: 'getPayslipPeriods', empId: currentPayslipEmpId, requesterId: currentUser }, function(res) {
          
          // ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin ‡∏Ñ‡πà‡∏≠‡∏¢‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
          if (res.isAdmin) {
              document.getElementById('ps_empNo_text').style.display = 'none';
              document.getElementById('ps_empNo_input_group').style.display = 'flex';
              
              // *** ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Input ‡∏î‡πâ‡∏ß‡∏¢ ***
              document.getElementById('ps_searchEmpInput').value = currentPayslipEmpId;
          }

          if (res.status === 'success' && res.data.length > 0) {
              select.innerHTML = '';
              res.data.forEach(p => { select.innerHTML += `<option value="${p}">‡∏á‡∏ß‡∏î ${p}</option>`; });
              select.selectedIndex = 0; 
              loadPayslipData();
          } else {
              select.innerHTML = '<option value="" selected disabled>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</option>';
              document.getElementById('ps_empNameDisplay').innerText = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏ß‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
              
              if (res.status === 'error') {
                  Swal.fire('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á', res.message, 'error');
              } else {
                  Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™: ' + currentPayslipEmpId, 'info');
              }
          }
      });
  }

  // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô loadPayslipData (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)
  function loadPayslipData() {
      const period = document.getElementById('payslipPeriodSelect').value;
      if (!period) return;
      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏•‡∏¥‡∏õ...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
      
      callAPI({ action: 'getPayslip', empId: currentPayslipEmpId, period: period, requesterId: currentUser }, function(res) {
          Swal.close();
          if (res.status === 'success') {
              // *** ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á res.empPhotoId ‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå ***
              renderPayslipUI(res.data, res.empName, res.empPhotoId);
          } else {
              Swal.fire('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á', res.message, 'error');
              
              if (currentPayslipEmpId !== currentUser) {
                  currentPayslipEmpId = currentUser;
                  loadPayslipPeriods();
              }
          }
      });
  }

  // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderPayslipUI (‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ empPhotoId ‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á)
  function renderPayslipUI(data, empName, empPhotoId) {
      document.getElementById('ps_empNameDisplay').innerText = empName || '-';

      // *** ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÅ‡∏•‡∏∞ ‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û) ***
      const imgEl = document.getElementById('ps_empProfileImg');
      if (String(currentPayslipEmpId) !== String(currentUser) && empPhotoId) {
          // ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Google Drive
          imgEl.src = "https://drive.google.com/thumbnail?id=" + empPhotoId + "&sz=s100";
          imgEl.style.display = 'block';
      } else {
          // ‡∏ñ‡πâ‡∏≤‡∏î‡∏π‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏π‡∏õ
          imgEl.style.display = 'none';
      }

      document.getElementById('ps_date').innerText = '‡∏à‡πà‡∏≤‡∏¢: ' + (data['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢'] || '-');
      document.getElementById('ps_dept').innerText = data['DEPT_CODE'] || '-';
      document.getElementById('ps_bank').innerText = data['‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£'] || '-';
      document.getElementById('ps_accNo').innerText = data['‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£'] || '';
      
      const formatMoney = (num) => Math.round(parseFloat(num || 0)).toLocaleString('th-TH');
      document.getElementById('ps_baseSalary').innerText = formatMoney(data['‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô']);

      let incomeHtml = '';
      let totalIncome = 0;
      incomeKeys.forEach(key => {
          let val = parseFloat(data[key] || 0);
          if (val > 0) { 
              let displayLabel = key; 
              if (key === '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏±‡∏ö') displayLabel = `‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (${data['‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'] || 0})`;
              else if (key === 'ot1 amt') displayLabel = `OT 1 (${parseFloat(data['OT1 (‡∏ä.‡∏°.)'] || 0).toFixed(1)})`;
              else if (key === 'ot15 amt') displayLabel = `OT 1.5 (${parseFloat(data['OT1.5 (‡∏ä.‡∏°.)'] || 0).toFixed(1)})`;
              else if (key === 'ot2 amt') displayLabel = `OT 2 (${parseFloat(data['OT2 (‡∏ä.‡∏°.)'] || 0).toFixed(1)})`;
              else if (key === 'ot3 amt') displayLabel = `OT 3 (${parseFloat(data['OT3 (‡∏ä.‡∏°.)'] || 0).toFixed(1)})`;

              incomeHtml += `<div class="d-flex justify-content-between text-secondary mb-1">
                                <span class="text-truncate pe-1">${displayLabel}</span> 
                                <span class="text-dark">${formatMoney(val)}</span>
                             </div>`;
              totalIncome += val;
          }
      });
      document.getElementById('ps_incomeList').innerHTML = incomeHtml || '<div class="text-muted">-</div>';
      document.getElementById('ps_totalIncome').innerText = formatMoney(totalIncome);

      let deductHtml = '';
      let totalDeduct = 0;
      deductKeys.forEach(key => {
          let val = parseFloat(data[key] || 0);
          if (val > 0) { 
              deductHtml += `<div class="d-flex justify-content-between text-secondary mb-1">
                                <span class="text-truncate pe-1">${key}</span> 
                                <span class="text-dark">${formatMoney(val)}</span>
                             </div>`;
              totalDeduct += val;
          }
      });
      document.getElementById('ps_deductList').innerHTML = deductHtml || '<div class="text-muted">-</div>';
      document.getElementById('ps_totalDeduct').innerText = formatMoney(totalDeduct);

      const netPay = totalIncome - totalDeduct;
      document.getElementById('ps_netPay').innerText = formatMoney(netPay);
      document.getElementById('ps_accIncome').innerText = formatMoney(data['‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏™‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏µ']);
      document.getElementById('ps_accTax').innerText = formatMoney(data['‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏∞‡∏™‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏µ']);
      document.getElementById('ps_accSSO').innerText = formatMoney(data['‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏µ']);
  }
  /*
  function openApp(appId) {
      var appConfig = systemConfigList.find(s => s.id === appId);
      if (appConfig && (appConfig.type === 'External' || appId.startsWith('http'))) {
          window.open(appId, '_blank'); 
          return; 
      }

      var allSections = [
          'portalSection', 
          'taAppSection', 
          'adminDashboardSection', 
          'adminVerifySection', 
          'adminUserSection',
          'adminImportPayslipSection', 
          'userPayslipSection'
      ];
      
      allSections.forEach(function(id) {
          var el = document.getElementById(id);
          if (el) el.classList.add('hidden');
      });

      document.getElementById('btnBackToHome').classList.remove('hidden');

      if (appId === 'TA') {
          document.getElementById('taAppSection').classList.remove('hidden');
          document.getElementById('historyDate').value = getLocalDateString();
          loadHistory(); 
      } 
      else if (appId === 'DASHBOARD') {
          document.getElementById('adminDashboardSection').classList.remove('hidden');
          document.getElementById('statsDate').valueAsDate = new Date();
          loadStats();
      }
      else if (appId === 'VERIFY') {
          document.getElementById('adminVerifySection').classList.remove('hidden');
          loadDeptForVerify();
      }
      else if (appId === 'USERS') {
          document.getElementById('adminUserSection').classList.remove('hidden');
          loadUserList();
      }
      else if (appId === 'PAYSLIP') {
          // ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ
          document.getElementById('userPayslipSection').classList.remove('hidden');
          loadPayslipPeriods();
      }
      else if (appId === 'IMPORT_PAYSLIP') {
          // ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏•‡∏¥‡∏õ
          document.getElementById('adminImportPayslipSection').classList.remove('hidden');
      }

      else {
          Swal.fire('Info', '‡∏£‡∏∞‡∏ö‡∏ö ' + appId + ' ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤', 'info');
          showPortal(); 
      }
  }

  // --- 4. ‡∏ù‡∏±‡πà‡∏á User: ‡∏î‡∏∂‡∏á‡∏á‡∏ß‡∏î ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏•‡∏¥‡∏õ ---
  function loadPayslipPeriods() {
      const select = document.getElementById('payslipPeriodSelect');
      select.innerHTML = '<option value="" selected disabled>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>';
      
      // ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏•‡∏¥‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÄ‡∏•‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô Header
      document.getElementById('payslipCard').classList.remove('hidden');
      
      // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠
      document.getElementById('ps_incomeList').innerHTML = '';
      document.getElementById('ps_deductList').innerHTML = '';
      document.getElementById('ps_totalIncome').innerText = '0.00';
      document.getElementById('ps_totalDeduct').innerText = '0.00';
      document.getElementById('ps_netPay').innerText = '0.00';

      callAPI({ action: 'getPayslipPeriods', empId: currentUser }, function(res) {
          if (res.status === 'success' && res.data.length > 0) {
              select.innerHTML = '';
              res.data.forEach(p => {
                  select.innerHTML += `<option value="${p}">‡∏á‡∏ß‡∏î ${p}</option>`;
              });
              
              // *** ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î) ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ***
              select.selectedIndex = 0; 
              loadPayslipData();
              
          } else {
              select.innerHTML = '<option value="" selected disabled>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</option>';
              Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì', 'info');
              document.getElementById('payslipCard').classList.add('hidden');
          }
      });
  }

  function loadPayslipData() {
      const period = document.getElementById('payslipPeriodSelect').value;
      if (!period) return;

      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏•‡∏¥‡∏õ...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
      
      callAPI({ action: 'getPayslip', empId: currentUser, period: period }, function(res) {
          Swal.close();
          if (res.status === 'success') {
              renderPayslipUI(res.data);
          } else {
              Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', res.message, 'warning');
          }
      });
  }

  // --- 5. ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤ Payslip (‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤ > 0) ---
  function renderPayslipUI(data) {
      document.getElementById('ps_date').innerText = '‡∏à‡πà‡∏≤‡∏¢: ' + (data['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢'] || '-');
      document.getElementById('ps_empNo').innerText = data['EMP_NO'] || '-';
      document.getElementById('ps_dept').innerText = data['DEPT_CODE'] || '-';
      document.getElementById('ps_bank').innerText = data['‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£'] || '-';
      document.getElementById('ps_accNo').innerText = data['‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£'] || '';

      // ‡∏õ‡∏£‡∏±‡∏ö Format Money: ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏° ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥
      const formatMoney = (num) => Math.round(parseFloat(num || 0)).toLocaleString('th-TH');

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏ê‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Column H) ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
      document.getElementById('ps_baseSalary').innerText = formatMoney(data['‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô']);

      // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏™‡∏µ‡∏ü‡πâ‡∏≤) ---
      let incomeHtml = '';
      let totalIncome = 0;
      incomeKeys.forEach(key => {
          let val = parseFloat(data[key] || 0);
          if (val > 0) { 
              let displayLabel = key; // ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô
              
              // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏±‡∏ö' ‡πÅ‡∏ó‡∏ô ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö
              if (key === '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏±‡∏ö') {
                  let workDays = data['‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'] || 0;
                  displayLabel = `‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (${workDays})`;
              } else if (key === 'ot1 amt') {
                  let hrs = parseFloat(data['OT1 (‡∏ä.‡∏°.)'] || 0).toFixed(1);
                  displayLabel = `OT 1 (${hrs})`;
              } else if (key === 'ot15 amt') {
                  let hrs = parseFloat(data['OT1.5 (‡∏ä.‡∏°.)'] || 0).toFixed(1);
                  displayLabel = `OT 1.5 (${hrs})`;
              } else if (key === 'ot2 amt') {
                  let hrs = parseFloat(data['OT2 (‡∏ä.‡∏°.)'] || 0).toFixed(1);
                  displayLabel = `OT 2 (${hrs})`;
              } else if (key === 'ot3 amt') {
                  let hrs = parseFloat(data['OT3 (‡∏ä.‡∏°.)'] || 0).toFixed(1);
                  displayLabel = `OT 3 (${hrs})`;
              }

              incomeHtml += `<div class="d-flex justify-content-between text-secondary mb-1">
                                <span class="text-truncate pe-1">${displayLabel}</span> 
                                <span class="text-dark">${formatMoney(val)}</span>
                             </div>`;
              totalIncome += val;
          }
      });
      document.getElementById('ps_incomeList').innerHTML = incomeHtml || '<div class="text-muted">-</div>';
      document.getElementById('ps_totalIncome').innerText = formatMoney(totalIncome);

      // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å (‡∏™‡∏µ‡πÅ‡∏î‡∏á) ---
      let deductHtml = '';
      let totalDeduct = 0;
      deductKeys.forEach(key => {
          let val = parseFloat(data[key] || 0);
          if (val > 0) { 
              deductHtml += `<div class="d-flex justify-content-between text-secondary mb-1">
                                <span class="text-truncate pe-1">${key}</span> 
                                <span class="text-dark">${formatMoney(val)}</span>
                             </div>`;
              totalDeduct += val;
          }
      });
      document.getElementById('ps_deductList').innerHTML = deductHtml || '<div class="text-muted">-</div>';
      document.getElementById('ps_totalDeduct').innerText = formatMoney(totalDeduct);

      // --- ‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ ---
      const netPay = totalIncome - totalDeduct;
      document.getElementById('ps_netPay').innerText = formatMoney(netPay);

      // --- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∞‡∏™‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏µ (YTD) ---
      document.getElementById('ps_accIncome').innerText = formatMoney(data['‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏™‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏µ']);
      document.getElementById('ps_accTax').innerText = formatMoney(data['‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏∞‡∏™‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏µ']);
      document.getElementById('ps_accSSO').innerText = formatMoney(data['‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏µ']);
  }
*/
</script>

</body>
</html>