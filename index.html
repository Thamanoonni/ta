<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/umd.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="icon" href="https://thamanoonni.github.io/ta/favicon.ico" type="image/x-icon">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  
  <meta name="theme-color" content="#0d6efd">
  
  <style>
    body { font-family: 'Kanit', sans-serif; background-color: #f4f6f9; }
    .card { border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .hidden { display: none !important; }
    .btn-primary { background-color: #0d6efd; border: none; }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex; justify-content: center; align-items: center;
        z-index: 3000;
    }
    .modal-content-box {
        background: white; width: 90%; max-width: 400px;
        border-radius: 15px; padding: 20px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }
    .token-debug {
        position: fixed; bottom: 2px; left: 2px; font-size: 8px; color: #ccc; z-index: 9999;
    }

    /* Map & Clock Styles */
    #liveMap { height: 250px; width: 100%; border-radius: 10px; z-index: 1; margin-bottom: 10px; border: 1px solid #ddd; }
    #liveClock { font-size: 3.5rem; font-weight: 600; color: #333; line-height: 1; letter-spacing: 2px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
    .status-badge-box { background: white; border: 1px solid #ddd; border-radius: 20px; padding: 5px 15px; display: inline-block; margin-bottom: 10px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

    /* Portal Grid Styles */
    .app-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 15px;
        padding: 10px;
    }
    .app-card {
        background: white;
        border-radius: 15px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid #eee;
    }
    .app-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .app-icon {
        width: 50px;
        height: 50px;
        object-fit: contain;
        margin-bottom: 8px;
    }
    .app-name {
        font-size: 0.85rem;
        font-weight: 600;
        color: #333;
        line-height: 1.2;
    }
    /* ‡∏õ‡∏∏‡πà‡∏° Back to Home ‡∏ö‡∏ô Header */
    .btn-home {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    
    html, body {
        height: 100%;           
        margin: 0;              
        padding: 0;
        overflow: hidden;       
    }
    
    .full-height-container {
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* --- Styles ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dashboard --- */
    .chart-container-main { position: relative; height: 250px; width: 100%; display: flex; justify-content: center; }
    .card-sub { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 10px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .center-text-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; }
    .center-value { font-size: 2rem; font-weight: bold; color: #0d6efd; line-height: 1; }
    .center-label { font-size: 0.8rem; color: #6c757d; }

    /* --- ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á USERS (Mobile Optimized) --- */
    .card-full-width {
        padding: 0 !important;
        overflow: hidden; 
        border-radius: 12px;
    }
    
    .table-wrapper {
        height: 75vh;      
        overflow-y: auto;  
        overflow-x: auto;  
        background: white;
    }

    .table-mobile {
        font-size: 0.85rem; 
        width: 100%;
        margin-bottom: 0;
        table-layout: fixed; 
    }

    .sticky-header th {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #f1f3f5;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        padding: 12px 5px;
        font-size: 0.8rem;
        white-space: nowrap;
    }

    .table-mobile td {
        padding: 8px 5px;
        vertical-align: middle;
        word-wrap: break-word; 
        white-space: normal;   
    }
    
    .col-img { width: 50px; text-align: center; }
    .col-info { width: auto; } 
    .col-status { width: 65px; text-align: center; }
    .col-action { width: 50px; text-align: center; }

  </style>
</head>
<body>

<div class="container p-0" style="max-width: 500px; height: 100%; position: relative;">
  
  <div id="inAppAlert" class="alert alert-danger hidden text-center fade-in">
      <h4 class="fw-bold"><i class="bi bi-exclamation-triangle"></i> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h4>
      <p class="mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE ‡∏´‡∏£‡∏∑‡∏≠ Facebook</p>
      <p class="small text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <b>‡∏à‡∏∏‡∏î 3 ‡∏à‡∏∏‡∏î</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>‡πÅ‡∏ä‡∏£‡πå</b><br>‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <b>"‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô" (Open in Safari/Chrome)</b></p>
  </div>

<div id="loginScreen" class="fade-in">
    
    <div class="card p-4 mb-3"> 
      <div class="text-center mb-3">
        <img id="loginLogo" src="" alt="Company Logo" style="width: 80px; height: auto; display: none;">
      </div>
      
      <h3 class="text-center mb-2">‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h3>
      <p class="text-center text-muted mb-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô</p>
      
      <input type="text" id="loginInput" class="form-control mb-3" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (User ID)">
      <input type="password" id="loginPass" class="form-control mb-4" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)">
      
      <div id="loginErrorMsg" class="text-danger small fw-bold mb-3" style="display:none; min-height: 20px;"></div>

      <button id="btnLogin" onclick="doLogin()" class="btn btn-primary w-100 py-2 fw-bold mb-2" disabled>
         ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö...
      </button>
      
      <button id="btnFaceLogin" onclick="startFaceLogin()" class="btn btn-outline-primary w-100 mt-2" disabled>
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î AI...
      </button>

    </div>

    <div class="mt-4 mb-4">
        <div class="bg-white rounded-4 shadow-sm p-3 mx-auto text-center" style="max-width: 90%;">
            
            <div class="d-flex align-items-center justify-content-center gap-2 mb-1">
                <img id="footerLogo" src="" style="height: 30px; width: auto; display: none;">
                <span class="fw-bold text-dark" style="font-size: 0.95rem; letter-spacing: 0.3px;">
                    <span class="companyNameText">Loading...</span>
                </span>
            </div>
            
            <div class="text-secondary small mt-1" style="font-size: 0.75rem;">
                ¬© 2026 Time Attendance System
            </div>
            
        </div>
    </div>

  </div>

  
  <div id="dashboardScreen" class="hidden fade-in" style="background-color: #f4f7f6; height: 100%; display: flex; flex-direction: column;">
     <header style="flex-shrink: 0; position: relative; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">

      <div class="bg-white py-2 px-3 d-flex justify-content-between align-items-center border-bottom">
          <div class="d-flex align-items-center">
             <img id="headerLogo" src="" alt="Logo" style="height: 32px; width: auto; object-fit: contain; display:none;" class="me-2">
             <span class="fw-bold text-dark companyNameText" style="font-size: 1rem; letter-spacing: 0.3px;"></span>
          </div>
          <button id="btnBackToHome" onclick="showPortal()" class="btn btn-light rounded-circle shadow-sm p-0 hidden" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border: 1px solid #eee;">
                <i class="bi bi-grid-fill text-primary" style="font-size: 1.1rem;"></i>
           </button>
      </div>
      
      <div class="bg-primary text-white px-3 py-3" style="border-radius: 0 0 20px 20px; background: linear-gradient(135deg, var(--bs-primary), #0a58ca);">
        <div class="d-flex align-items-center px-2">
          <div class="me-3 bg-white rounded-circle d-flex justify-content-center align-items-center overflow-hidden shadow" style="width: 50px; height: 50px; border: 2px solid rgba(255,255,255,0.9);">
            <img id="userProfileImg" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
            <span id="defaultUserIcon" style="font-size: 24px; color: #ccc; display:none;">üë§</span>
          </div>
          <div>
             <h5 id="userNameDisplay" class="mb-0 fw-bold" style="text-shadow: 0 1px 2px rgba(0,0,0,0.1); font-size: 1.1rem;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h5>
             <small id="currentDateDisplay" class="opacity-75" style="font-size: 0.8rem; display: block; font-weight: 300;"></small>
          </div>
        </div>
      </div>
    </header>

    <div class="container-fluid px-3 pb-4" style="flex-grow: 1; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; position: relative; z-index: 1; margin-top: -20px; padding-top: 10px;">

      <div id="portalSection" class="px-1">
          <div class="bg-white rounded-4 p-3 shadow-sm">
             <h6 class="text-muted mb-3 small fw-bold text-uppercase ps-2 border-start border-3 border-primary">‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (My Apps)</h6>
             <div id="appGrid" class="app-grid">
                 </div>
          </div>
      </div>

      <div id="taAppSection" class="hidden px-1">
          <div class="card p-3 mb-3 shadow-sm border-0">
              <label class="form-label fw-bold small text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥:</label>
              <input type="date" id="historyDate" class="form-control mb-3" onchange="loadHistory()">
              
              <div id="liveLocationSection" class="hidden text-center mb-3">
                  <div id="liveMap"></div>
                  <div class="status-badge-box">
                      <span id="locationStatusIcon">‚Üª</span> <span id="locationStatusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î...</span>
                  </div>
                  <div id="liveClock" style="font-family: 'Courier New', monospace; letter-spacing: -1px;">--:--:--</div>
              </div>

              <button id="btnScan" onclick="openCamera()" class="btn btn-warning w-100 py-3 text-white fw-bold shadow-sm hidden" style="border-radius: 12px; font-size: 1.1rem;">
                üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Scan)
              </button>
          </div>

          <div class="card p-3 shadow-sm border-0">
              <h6 class="border-bottom pb-2 mb-3 fw-bold text-primary">
                  <i class="bi bi-clock-history me-1"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
              </h6>
              <ul id="historyList" class="list-group list-group-flush small"></ul>
          </div>
      </div>

      <div id="adminDashboardSection" class="hidden px-1">
         
         <div class="card p-3 mb-3 shadow-sm border-0">
            <h5 class="fw-bold text-primary mb-3"><i class="bi bi-pie-chart-fill"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h5>
            
            <div class="d-flex gap-2 mb-3">
               
               <input type="date" id="statsDate" class="form-control form-control-sm" onchange="clearDashboard()">
               <button onclick="loadStats()" class="btn btn-sm btn-primary" style="width: 40px;" title="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">
                  <i class="bi bi-search"></i>
               </button>
            </div>

            <div class="chart-container-main">
               <canvas id="mainAreaChart"></canvas>
               <div class="center-text-overlay">
                  <div class="center-label">‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
                  <div class="center-value" id="centerTotalDisplay">0</div>
                  <div class="center-label">‡∏Ñ‡∏ô</div>
               </div>
            </div>
         </div>

         <div id="subChartsArea" class="row g-2">
        </div>

      </div>

      <div id="adminUserSection" class="hidden px-1">
         <div class="card shadow-sm border-0 card-full-width" style="height: 85vh; display: flex; flex-direction: column;">
            
            <div class="p-3 border-bottom bg-white" style="flex-shrink: 0;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                   <h5 class="fw-bold text-primary m-0"><i class="bi bi-people-fill"></i> ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h5>
                   <button onclick="openUserModal('add')" class="btn btn-sm btn-success fw-bold shadow-sm">
                       <i class="bi bi-person-plus-fill"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°
                   </button>
                </div>
                
                <div class="d-flex gap-2">
                   <select id="filterDept" class="form-select form-select-sm" style="width: 140px;" onchange="filterUserTable()">
                       <option value="">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>
                       </select>
                   <div class="input-group input-group-sm">
                       <span class="input-group-text bg-light border-end-0"><i class="bi bi-search text-muted"></i></span>
                       <input type="text" id="searchUser" class="form-control border-start-0 bg-light" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ / ‡∏£‡∏´‡∏±‡∏™..." onkeyup="filterUserTable()">
                   </div>
                </div>
            </div>

            <div class="table-wrapper bg-white">
               <table class="table table-hover table-mobile align-middle mb-0">
                  <thead class="table-light sticky-header">
                      <tr>
                          <th class="col-img">‡∏£‡∏π‡∏õ</th>
                          <th class="col-info">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                          <th class="col-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                          <th class="col-action">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
                      </tr>
                  </thead>
                  <tbody id="userTableBody">
                      </tbody>
               </table>
            </div>
         </div>
      </div>

      <div class="px-3">
          <button onclick="doLogout()" class="btn btn-outline-danger w-100 mt-4 rounded-pill py-2 fw-bold" style="border-width: 2px;">
              <i class="bi bi-box-arrow-right me-2"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
          </button>
      </div>

    </div>
  </div>

  <div id="setupPassScreen" class="card p-4 hidden fade-in">
    <h4 class="text-center mb-3 text-warning">üîê ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h4>
    <p class="text-center small text-muted">‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</p>
    <div class="alert alert-light text-center border mb-3">
        <div class="fw-bold text-primary" id="setupShowName" style="font-size: 1.1rem;">-</div>
        <small class="text-muted">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <span id="setupShowId">-</span></small>
    </div>
    <input type="hidden" id="setupEmpId">
    <div class="mb-3">
        <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
        <input type="password" id="newPass" class="form-control" placeholder=">= 8 ‡∏ï‡∏±‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‡πÄ‡∏•‡πá‡∏Å/‡πÉ‡∏´‡∏ç‡πà/‡πÄ‡∏•‡∏Ç/‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©">
    </div>
    <div class="mb-4">
        <label class="form-label">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
        <input type="password" id="confirmPass" class="form-control" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ã‡πâ‡∏≥‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á">
    </div>
    <button onclick="doSubmitNewPassword()" class="btn btn-warning w-100 fw-bold text-white">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <button onclick="showLogin()" class="btn btn-link w-100 mt-2 text-muted">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>

  <div id="registerScreen" class="card p-4 hidden">
    <h4 class="text-center mb-3">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h4>
    <input type="text" id="regEmpId" class="form-control mb-2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">
    <input type="text" id="regFname" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠">
    <input type="text" id="regLname" class="form-control mb-2" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
    <select id="regDept" class="form-select mb-2">
      <option value="" selected disabled>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å...</option>
    </select>
    <input type="email" id="regEmail" class="form-control mb-2" placeholder="Email">
    <input type="password" id="regPass" class="form-control mb-2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (8+ ‡∏ï‡∏±‡∏ß, ‡πÉ‡∏´‡∏ç‡πà, ‡πÄ‡∏•‡πá‡∏Å, ‡πÄ‡∏•‡∏Ç, ‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©)">
    <input type="password" id="regConfirmPass" class="form-control mb-2" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
    <small class="text-danger hidden" id="passError">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</small>
    <button onclick="doRegister()" class="btn btn-success w-100 mt-3">‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™ OTP</button>
    <button onclick="showLogin()" class="btn btn-link w-100 mt-1">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Login</button>
  </div>

  <div id="otpScreen" class="card p-4 hidden">
    <h4 class="text-center">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™ OTP</h4>
    <p class="text-center text-muted">‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà Email ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß</p>
    <input type="text" id="otpInput" class="form-control mb-3 text-center" placeholder="XXXXXX" maxlength="6">
    <button onclick="doConfirmOTP()" class="btn btn-primary w-100">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
  </div>

  <div id="faceLoginModal" class="modal-overlay hidden">
    <div class="modal-content-box">
        <div class="text-center">
            <h5 class="mb-3 fw-bold text-primary"><i class="bi bi-person-check-fill"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h5>
            <div id="faceLoading" class="text-warning small mb-2 fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á...</div>
            <div style="position: relative; width: 100%; height: 300px; background: #000; border-radius: 10px; overflow: hidden; margin: 0 auto;">
                <video id="faceVideo" autoplay muted playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
                <canvas id="faceCanvas" style="position: absolute; top: 0; left: 0;"></canvas>
            </div>
            <div id="faceStatus" class="mt-3 text-dark small fw-bold">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á</div>
            <button onclick="closeFaceLogin()" class="btn btn-secondary mt-3 w-100 rounded-pill">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
  </div>

  <div id="cameraModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:9999; display:none; flex-direction:column; justify-content:center; align-items:center;">
    <video id="videoFeed" autoplay playsinline style="width:100%; height:100%; object-fit:cover;"></video>
    <div style="position:absolute; bottom:30px; width:100%; text-align:center; z-index:10000;">
      <button onclick="snapPhoto()" class="btn btn-warning rounded-circle shadow" style="width:80px; height:80px; border:4px solid white; padding:0; font-size:30px;">üì∏</button>
      <br><br>
      <button onclick="closeCamera()" class="btn btn-outline-light btn-sm px-4 rounded-pill">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>

  <div class="modal fade" id="userFormModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-primary text-white">
          <h6 class="modal-title fw-bold" id="userModalTitle"><i class="bi bi-person-lines-fill"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h6>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-3">
           <form id="userForm">
              <input type="hidden" id="formMode">
              
              <div class="row g-2 mb-2">
                 <div class="col-4">
                     <label class="small fw-bold text-muted">‡∏£‡∏´‡∏±‡∏™</label>
                     <input type="text" id="u_empId" class="form-control form-control-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô 001">
                 </div>
                 <div class="col-8">
                     <label class="small fw-bold text-muted">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                     <input type="email" id="u_email" class="form-control form-control-sm">
                 </div>
              </div>

              <div class="row g-2 mb-2">
                 <div class="col-6">
                     <label class="small fw-bold text-muted">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á</label>
                     <input type="text" id="u_fname" class="form-control form-control-sm">
                 </div>
                 <div class="col-6">
                     <label class="small fw-bold text-muted">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                     <input type="text" id="u_lname" class="form-control form-control-sm">
                 </div>
              </div>

              <div class="mb-2">
                  <label class="small fw-bold text-muted">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                  <select id="u_dept" class="form-select form-select-sm bg-light">
                      <option value="" selected disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>
                  </select>
              </div>

              <div class="row g-2 mb-3">
                 <div class="col-6">
                     <label class="small fw-bold text-muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                     <select id="u_status" class="form-select form-select-sm">
                        <option value="Active" class="text-success fw-bold">Active (‡∏õ‡∏Å‡∏ï‡∏¥)</option>
                        <option value="Inactive" class="text-danger">Inactive (‡∏•‡∏≤‡∏≠‡∏≠‡∏Å)</option>
                        <option value="Admin" class="text-primary fw-bold">Admin</option>
                     </select>
                 </div>
                 <div class="col-6">
                     <label class="small fw-bold text-muted">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</label>
                     <input type="date" id="u_startDate" class="form-control form-control-sm">
                 </div>
              </div>
              
              <div id="editTools" class="border-top pt-2 mt-2 hidden">
                  <label class="small fw-bold text-muted mb-2">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏û‡∏¥‡πÄ‡∏®‡∏©</label>
                  <div class="d-flex gap-2">
                      <button type="button" class="btn btn-sm btn-outline-warning w-100" onclick="resetUserField('password')">
                          <i class="bi bi-key"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-danger w-100" onclick="resetUserField('token')">
                          <i class="bi bi-phone"></i> ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
                      </button>
                  </div>
              </div>

              <div class="mb-3 border p-2 rounded bg-light">
                  <label class="small fw-bold text-muted mb-1">‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
                  <input type="file" id="u_photoFile" class="form-control form-control-sm mb-2" accept="image/*" onchange="previewImage(this)">
                  <input type="hidden" id="u_currentPhotoId"> 
                  <div class="text-center">
                      <img id="u_previewImg" src="" class="rounded shadow-sm hidden" style="max-height: 100px; max-width: 100%;">
                      <div id="u_noImageText" class="text-muted small py-2">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -</div>
                  </div>
              </div>

              <div class="mb-3">
                  <label class="small fw-bold text-muted mb-1">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Allowed Systems)</label>
                  <div id="systemCheckboxContainer" class="border rounded p-2 bg-white" style="max-height: 100px; overflow-y: auto;">
                      </div>
                  <div class="form-check mt-1">
                      <input class="form-check-input" type="checkbox" id="chk_AllSystems" onchange="toggleAllSystems()">
                      <label class="form-check-label small text-primary" for="chk_AllSystems">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</label>
                  </div>
              </div>

           </form>
        </div>
        <div class="modal-footer bg-light py-2">
           <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
           <button type="button" class="btn btn-primary btn-sm px-4 fw-bold" onclick="saveUser()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </div>
    </div>
  </div>
  
  <div id="tokenDebug" class="token-debug"></div>

</div>

<script>
  // ==========================================
  // 1. CONFIGURATION
  // ==========================================
  
  // *** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ô‡∏≥ URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å New Deployment (Code.gs) ‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ***
  const API_URL = "https://script.google.com/macros/s/AKfycbwYa587lK3EQ39Do1k-Xoy97rmYdI2PS4koJDAixkO9zw6S2YqPLO6eVix9l-IEp2bC/exec" ; 

  const APP_CONFIG = {
      COMPANY_NAME: '‡∏ß‡∏¥‡∏™‡∏î‡∏≠‡∏° ‡∏≠‡∏≠‡πÇ‡∏ï‡πâ‡∏û‡∏≤‡∏£‡πå‡∏ó',
      
      // 1. ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÄ‡∏•‡πá‡∏Å (Header ‡∏´‡∏ô‡πâ‡∏≤ Dashboard)
      LOGO_HEADER: 'https://drive.google.com/thumbnail?id=1RbfQoTcWEU6Y4USFIV9XjmAjgpx87hvA&sz=w1000', 
      
      // 2. ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÉ‡∏´‡∏ç‡πà (‡∏´‡∏ô‡πâ‡∏≤ Login ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô")
      // ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      LOGO_LOGIN: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png' 
  };
  // ==========================================
  // 2. CORE LOGIC
  // ==========================================

  var currentUser = null;
  var tempEmail = '';
  var lastScanTime = null; 
  var myDeviceToken = null; 
  var isAutoLoginCancelled = false; 

  var mapObj = null;
  var userMarker = null;
  var areaCircle = null;
  var watchId = null;
  var clockInterval = null;
  var targetLat = 0;
  var targetLng = 0;
  var allowedRadius = 0;
  var isLocationValid = false;
  var isHistoryLoaded = false;

  var pendingBroadcastData = { msg: null, token: null, name: null, photo: null, allowedApps: null, sysConfig: null };
  var userAllowedApps = [];
  var systemConfigList = [];

  // --- INITIALIZATION ---
  document.addEventListener('DOMContentLoaded', async function() {
    setupUIFromConfig();

    var ua = navigator.userAgent || navigator.vendor || window.opera;
    var isInApp = (ua.indexOf("FBAN") > -1) || (ua.indexOf("FBAV") > -1) || (ua.indexOf("Line") > -1);
    if (isInApp) { document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('inAppAlert').classList.remove('hidden'); return; }

    await initDeviceToken();
    
    var btnLogin = document.getElementById('btnLogin');
    btnLogin.disabled = false;
    btnLogin.innerText = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';

    checkAutoLogin();
    
    document.getElementById('loginPass').addEventListener("keypress", function(event) {
      if (event.key === "Enter") doLogin();
    });

    document.getElementById('loginInput').addEventListener('input', function() {
        resetSystemState(); 
    });
    
    loadFaceModels();
  });

  function setupUIFromConfig() {
      // Login Screen
      document.getElementById('loginLogo').src = APP_CONFIG.LOGO_LOGIN;
      document.getElementById('loginLogo').style.display = 'inline-block';
      
      document.getElementById('footerLogo').src = APP_CONFIG.LOGO_HEADER;
      document.getElementById('footerLogo').style.display = 'block';

      // Header Dashboard
      document.getElementById('headerLogo').src = APP_CONFIG.LOGO_HEADER;
      document.getElementById('headerLogo').style.display = 'block';

      // Set Texts
      const nameEls = document.querySelectorAll('.companyNameText');
      nameEls.forEach(el => el.innerText = APP_CONFIG.COMPANY_NAME);
  }

  // --- API HANDLER (Main Fetch) ---
  async function callAPI(data, callback) {
      try {
          const response = await fetch(API_URL, {
              method: "POST",
              body: JSON.stringify(data),
              headers: { "Content-Type": "text/plain;charset=utf-8" } 
          });
          
          const result = await response.json();
          if (callback) callback(result);
          return result;

      } catch (error) {
          console.error("API Error:", error);
          Swal.fire({ icon: 'error', title: 'Connection Error', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ' });
          return { status: 'error', message: error.toString() };
      }
  }

  function resetSystemState() {
      if (!isAutoLoginCancelled) {
          isAutoLoginCancelled = true;
          localStorage.removeItem('saved_emp_id');
          closeFaceLogin();
          const video = document.getElementById('faceVideo');
          if (video.srcObject) { 
              video.srcObject.getTracks().forEach(t => t.stop()); 
              video.srcObject = null;
          }
      }
  }

  // --- MAP & LOCATION LOGIC ---
  function initMap() {
      if (!mapObj) {
          mapObj = L.map('liveMap', { zoomControl: false }).setView([13.7563, 100.5018], 15);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '¬© OpenStreetMap'
          }).addTo(mapObj);
      }
      
      callAPI({ action: 'getEmpConfig', empId: currentUser }, function(config) {
          if (config && config.lat && config.lng) {
              targetLat = config.lat;
              targetLng = config.lng;
              allowedRadius = config.dist || 500;
              startWatchingLocation();
          }
      });
  }

  function startWatchingLocation() {
      if (navigator.geolocation) {
          watchId = navigator.geolocation.watchPosition(function(position) {
              var lat = position.coords.latitude;
              var lng = position.coords.longitude;
              updateMapPosition(lat, lng);
          }, function(error) {
              console.error("GPS Error", error);
              document.getElementById('locationStatusText').innerText = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS";
              document.getElementById('locationStatusText').style.color = 'red';
              document.getElementById('btnScan').classList.add('hidden'); 
          }, { enableHighAccuracy: true, maximumAge: 10000, timeout: 30000 });
      }
  }

  function updateMapPosition(lat, lng) {
      if (!mapObj) return;

      var center = [lat, lng];
      if (userMarker) {
          userMarker.setLatLng(center);
      } else {
          var userIcon = L.divIcon({
              className: 'user-pin',
              html: '<div style="background-color: #0d6efd; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.5);"></div>',
              iconSize: [15, 15]
          });
          userMarker = L.marker(center, {icon: userIcon}).addTo(mapObj);
      }
      mapObj.setView(center);

      var dist = getDistanceFromLatLonInKm(lat, lng, targetLat, targetLng) * 1000;
      
      if (areaCircle) mapObj.removeLayer(areaCircle);

      var statusText = document.getElementById('locationStatusText');
      var statusIcon = document.getElementById('locationStatusIcon');
      var statusBox = document.querySelector('.status-badge-box');
      var btnScan = document.getElementById('btnScan');

      if (dist <= allowedRadius) {
          areaCircle = L.circle([targetLat, targetLng], {
              color: '#28a745',
              fillColor: '#28a745',
              fillOpacity: 0.3,
              radius: allowedRadius
          }).addTo(mapObj);
          
          statusText.innerText = "‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (" + Math.round(dist) + " ‡∏°.)";
          statusIcon.innerText = "‚úî";
          statusBox.style.borderColor = "#28a745";
          statusBox.style.color = "#28a745";
          statusBox.style.backgroundColor = "#e8f5e9";
          isLocationValid = true;
          checkScanAvailability();
      } else {
          statusText.innerText = "‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏´‡πà‡∏≤‡∏á " + (dist/1000).toFixed(2) + " ‡∏Å‡∏°.)";
          statusIcon.innerText = "‚úñ";
          statusBox.style.borderColor = "#dc3545";
          statusBox.style.color = "#dc3545";
          statusBox.style.backgroundColor = "#f8d7da";
          isLocationValid = false;
          checkScanAvailability();
      }
  }

  function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
      var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1);
      var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
  }
  function deg2rad(deg) { return deg * (Math.PI/180); }

  function startClock() {
      if (clockInterval) clearInterval(clockInterval);
      function update() {
          var now = new Date();
          var timeStr = now.toLocaleTimeString('th-TH', { hour12: false });
          document.getElementById('liveClock').innerText = timeStr;
      }
      update();
      clockInterval = setInterval(update, 1000);
  }
  function stopClock() { if (clockInterval) clearInterval(clockInterval); }


  // --- GENERAL FUNCTIONS ---
  function loginSuccess(token, name, photoUrl, allowedApps, sysConfig) { 
      currentUser = token; 
      localStorage.setItem('saved_emp_id', token); 

      userAllowedApps = allowedApps ? allowedApps.split(',') : ['TA']; 
      systemConfigList = sysConfig || [];

      if(photoUrl) localStorage.setItem('saved_user_photo', photoUrl);
      document.getElementById('userNameDisplay').innerText = name;
      var imgEl = document.getElementById('userProfileImg'); var iconEl = document.getElementById('defaultUserIcon');
      if(!photoUrl) photoUrl = localStorage.getItem('saved_user_photo');
      if (photoUrl && photoUrl.trim() !== "") { imgEl.src = photoUrl; imgEl.style.display = 'block'; iconEl.style.display = 'none'; } else { imgEl.style.display = 'none'; iconEl.style.display = 'block'; }

      renderPortalApps();
      showDashboard();
  }

  function renderPortalApps() {
      var grid = document.getElementById('appGrid');
      grid.innerHTML = '';

      if (systemConfigList.length === 0) {
           grid.innerHTML = '<p class="text-muted small w-100">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>';
           return;
      }

      systemConfigList.forEach(function(sys) {
          if (userAllowedApps.includes(sys.id) || userAllowedApps.includes('All')) {
              var card = document.createElement('div');
              card.className = 'app-card fade-in';
              card.onclick = function() { openApp(sys.id); };
              
              var iconVal = sys.icon || 'fa-solid fa-circle-question'; 
              var iconHtml = '';

              if (iconVal.includes('http') || iconVal.includes('data:image')) {
                  iconHtml = `<img src="${iconVal}" class="app-icon" style="width: 50px; height: 50px; object-fit: contain; margin-bottom: 8px;">`;
              } else {
                  iconHtml = `<div class="mb-2"><i class="${iconVal}" style="font-size: 40px; color: #0d6efd;"></i></div>`;
              }
              
              card.innerHTML = `
                  ${iconHtml}
                  <div class="app-name">${sys.name}</div>
              `;
              grid.appendChild(card);
          }
      });
  }

  function openApp(appId) {
      var appConfig = systemConfigList.find(s => s.id === appId);
      if (appConfig && (appConfig.type === 'External' || appId.startsWith('http'))) {
          window.open(appId, '_blank'); 
          return; 
      }

      var allSections = [
          'portalSection', 
          'taAppSection', 
          'adminDashboardSection', 
          'adminVerifySection', 
          'adminUserSection'
      ];
      
      allSections.forEach(function(id) {
          var el = document.getElementById(id);
          if (el) el.classList.add('hidden');
      });

      document.getElementById('btnBackToHome').classList.remove('hidden');

      if (appId === 'TA') {
          document.getElementById('taAppSection').classList.remove('hidden');
          document.getElementById('historyDate').value = getLocalDateString();
          loadHistory(); 
      } 
      else if (appId === 'DASHBOARD') {
          document.getElementById('adminDashboardSection').classList.remove('hidden');
          document.getElementById('statsDate').valueAsDate = new Date();
          loadStats();
      }
      else if (appId === 'VERIFY') {
          document.getElementById('adminVerifySection').classList.remove('hidden');
          loadDeptForVerify();
      }
      else if (appId === 'USERS') {
          document.getElementById('adminUserSection').classList.remove('hidden');
          loadUserList();
      }
      else {
          Swal.fire('Info', '‡∏£‡∏∞‡∏ö‡∏ö ' + appId + ' ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤', 'info');
          showPortal(); 
      }
  }

  function showPortal() {
      if (watchId) navigator.geolocation.clearWatch(watchId);
      stopClock();

      var allSections = [
          'taAppSection', 
          'adminDashboardSection',
          'adminVerifySection', 
          'adminUserSection'
      ];
      
      allSections.forEach(function(id) {
          var el = document.getElementById(id);
          if (el) el.classList.add('hidden');
      });

      document.getElementById('portalSection').classList.remove('hidden');
      document.getElementById('btnBackToHome').classList.add('hidden'); 
  }

function showDashboard() { 
    hideAll(); 
    document.getElementById('dashboardScreen').classList.remove('hidden');
    document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    showPortal();
  }

function loadHistory() { 
    isHistoryLoaded = false; 
    checkScanAvailability(); 

    var date = document.getElementById('historyDate').value;
    var today = getLocalDateString();
    
    if (date === today) {
        document.getElementById('liveLocationSection').classList.remove('hidden');
        document.getElementById('btnScan').classList.add('hidden'); 
        setTimeout(() => { 
            initMap(); 
            if(mapObj) mapObj.invalidateSize(); 
        }, 300);
        startClock();
    } else {
        document.getElementById('liveLocationSection').classList.add('hidden');
        if (watchId) navigator.geolocation.clearWatch(watchId);
        stopClock();
    }

    callAPI({ action: 'getHistory', empId: currentUser, filterDate: date }, function(res) { 
        var list = document.getElementById('historyList'); 
        list.innerHTML = ''; 
        lastScanTime = null; 
        if (res.status !== 'success') {
             list.innerHTML = '<li class="list-group-item text-center text-danger">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (res.message || 'Unknown Error') + '</li>';
             isHistoryLoaded = true;
             checkScanAvailability();
             return;
        }
        
        if(res.data.length === 0) { 
            list.innerHTML = '<li class="list-group-item text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô</li>'; 
        } else { 
            var lastItem = res.data[res.data.length - 1];
            lastScanTime = lastItem.time; 
        } 
        
        res.data.forEach(function(item) { 
            var li = `<li class="list-group-item d-flex justify-content-between align-items-center"><span>‚è∞ ${item.time}</span><a href="https://www.google.com/maps/search/?api=1&query=${item.lat},${item.lng}" target="_blank" class="btn btn-sm btn-outline-info">Map</a></li>`; 
            list.innerHTML += li; 
        }); 
        isHistoryLoaded = true; 
        checkScanAvailability();
    }); 
  }

  function checkScanAvailability() {
      var btn = document.getElementById('btnScan');
      var dateVal = document.getElementById('historyDate').value;
      var today = getLocalDateString();

      if (dateVal !== today) {
          btn.disabled = true;
          btn.classList.remove('hidden'); 
          btn.classList.add('btn-secondary');
          btn.classList.remove('btn-warning');
          btn.innerHTML = 'üö´ ‡∏î‡∏π‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (‡∏á‡∏î‡∏™‡πÅ‡∏Å‡∏ô)';
          return;
      }

      if (!isLocationValid) {
          btn.classList.add('hidden');
          return;
      }

      if (!isHistoryLoaded) {
          btn.classList.remove('hidden'); 
          btn.disabled = true;            
          btn.classList.add('btn-secondary');
          btn.classList.remove('btn-warning');
          btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...'; 
          return;
      }

      if (lastScanTime) {
          var now = new Date();
          var last = new Date();
          var parts = lastScanTime.split(':');
          last.setHours(parseInt(parts[0]), parseInt(parts[1]), parseInt(parts[2]), 0);

          var nextScanTime = new Date(last.getTime() + (2 * 60 * 60 * 1000));

          if (now < nextScanTime) {
              var timeStr = nextScanTime.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
              
              btn.classList.remove('hidden');
              btn.disabled = true; 
              btn.classList.add('btn-secondary');
              btn.classList.remove('btn-warning');
              btn.innerHTML = `‚è≥ ‡∏£‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ${timeStr}`;
              return;
          }
      }

      btn.classList.remove('hidden');
      btn.disabled = false; 
      btn.classList.remove('btn-secondary');
      btn.classList.add('btn-warning');
      btn.innerHTML = 'üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Scan)';
  }

  function setCookie(name, value, days) { var expires = ""; if (days) { var date = new Date(); date.setTime(date.getTime() + (days*24*60*60*1000)); expires = "; expires=" + date.toUTCString(); } document.cookie = name + "=" + (value || "")  + expires + "; path=/"; }
  function getCookie(name) { var nameEQ = name + "="; var ca = document.cookie.split(';'); for(var i=0;i < ca.length;i++) { var c = ca[i]; while (c.charAt(0)==' ') c = c.substring(1,c.length); if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length); } return null; }

  async function initDeviceToken() {
      myDeviceToken = getCookie('my_device_token');
      if (!myDeviceToken) { try { myDeviceToken = await idbKeyval.get('my_device_token'); } catch (e) {} }
      if (!myDeviceToken) { myDeviceToken = localStorage.getItem('my_device_token'); }
      if (!myDeviceToken) { myDeviceToken = 'DEV-' + new Date().getTime() + '-' + Math.floor(Math.random() * 100000); }
      localStorage.setItem('my_device_token', myDeviceToken);
      setCookie('my_device_token', myDeviceToken, 3650);
      try { await idbKeyval.set('my_device_token', myDeviceToken); } catch (e) {}
      document.getElementById('tokenDebug').innerText = myDeviceToken;
  }
  function getDeviceToken() { return myDeviceToken; }

  // --- LOGIN ---
  function doLogin() {
    resetSystemState();
    
    var loginIdVal = document.getElementById('loginInput').value;
    var loginPassVal = document.getElementById('loginPass').value;
    var errBox = document.getElementById('loginErrorMsg');
    var btn = document.getElementById('btnLogin');
    
    errBox.style.display = 'none';
    errBox.innerText = '';
    
    if(!getDeviceToken()) {
        errBox.innerText = 'Error: ‡πÑ‡∏°‡πà‡∏û‡∏ö Device Token';
        errBox.style.display = 'block';
        return;
    }

    if(!loginIdVal) { errBox.innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å User ID'; errBox.style.display = 'block'; return; }

    var originalText = btn.innerText;
    btn.disabled = true; btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

    var data = { action: 'login', loginId: loginIdVal, password: loginPassVal, deviceToken: getDeviceToken(), os: getMobileOS() };
    
    callAPI(data, function(res) {
      btn.disabled = false; btn.innerText = originalText;
      if(res.status === 'success') { 
        if (res.broadcast && res.broadcast.toString().trim() !== "") {
              showBroadcast(res.broadcast, function() {
                  loginSuccess(res.token, res.name, res.photo, res.allowedApps, res.systemConfig); 
              });
        } else {
            loginSuccess(res.token, res.name, res.photo, res.allowedApps, res.systemConfig); 
        } 
      } else if (res.status === 'force_setup') {
        document.getElementById('setupEmpId').value = res.empId;
        document.getElementById('setupShowName').innerText = res.name;
        document.getElementById('setupShowId').innerText = res.empId;
        hideAll();
        document.getElementById('setupPassScreen').classList.remove('hidden');
        Swal.fire({ icon: 'info', title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' });
      } else {
        errBox.innerText = res.message || 'Login Error'; errBox.style.display = 'block';
      }
    });
  }

  function getMobileOS() {
    var ua = navigator.userAgent || navigator.vendor || window.opera;
    var platform = navigator.platform || "";
    if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) return 'iOS';
    if (platform === 'MacIntel' && navigator.maxTouchPoints > 1) return 'iOS'; 
    if (/android/i.test(ua)) return 'Android';
    return 'unknown';
  }

  function checkAutoLogin() {
    var savedEmpId = localStorage.getItem('saved_emp_id');
    var savedToken = getDeviceToken(); 
    if (savedEmpId) { document.getElementById('loginInput').value = savedEmpId; }

    if (savedEmpId && savedToken) {
      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } });
      var data = { action: 'autoLogin', empId: savedEmpId, deviceToken: savedToken };
      
      callAPI(data, function(res) {
        Swal.close();
        if (isAutoLoginCancelled) return; 

        if (res.status === 'success') {
           var finalLoginStep = function() {
               loginSuccess(res.token, res.name, res.photo, res.allowedApps, res.systemConfig);
           };

           var processBroadcast = function() {
                if (res.broadcast && res.broadcast.toString().trim() !== "") {
                    showBroadcast(res.broadcast, finalLoginStep);
                } else {
                    finalLoginStep();
                }
           };

           if (res.photo && res.photo.length > 100) {
               if (faceModelsLoaded) { 
                   startFaceLoginWithBroadcast(res.broadcast, res.token, res.name, res.photo, res.allowedApps, res.systemConfig); 
               } else {
                   Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...', didOpen: () => { Swal.showLoading() } });
                   var waitForAI = setInterval(function() {
                       if (isAutoLoginCancelled) { clearInterval(waitForAI); Swal.close(); return; } 
                       if (faceModelsLoaded) { 
                           clearInterval(waitForAI); 
                           Swal.close(); 
                           startFaceLoginWithBroadcast(res.broadcast, res.token, res.name, res.photo, res.allowedApps, res.systemConfig); 
                       }
                   }, 500);
               }
           } else { 
               processBroadcast();
           }
        } else { 
            showLogin(); 
        }
      });
    } else { 
        showLogin(); 
    }
  }

function startFaceLoginWithBroadcast(msg, token, name, photo, allowedApps, sysConfig) {
    pendingBroadcastData = { 
        msg: msg, 
        token: token, 
        name: name, 
        photo: photo, 
        allowedApps: allowedApps, 
        sysConfig: sysConfig      
    };
    startFaceLogin();
}

  function startFaceLogin() {
    closeFaceLogin(); 
    if (isAutoLoginCancelled) {
        var currentInput = document.getElementById('loginInput').value;
    }

    var empId = document.getElementById('loginInput').value;
    if (!empId) { Swal.fire('‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô', 'warning'); return; }
    
    if(!getDeviceToken()) {
        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö Device Token', 'error');
        return;
    }
    
    if (!faceModelsLoaded) { Swal.fire({ icon: 'error', title: 'AI ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°', text: '‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...' }); return; }

    document.getElementById('faceLoginModal').classList.remove('hidden');
    document.getElementById('faceStatus').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...';
    document.getElementById('faceLoading').innerText = '';

    if (pendingBroadcastData.photo) {
         try {
            document.getElementById('faceStatus').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...';
            prepareReferenceFace(pendingBroadcastData.photo, pendingBroadcastData.name)
            .then(() => {
                startFaceCamera(empId, pendingBroadcastData.name, pendingBroadcastData.photo, pendingBroadcastData.allowedApps, pendingBroadcastData.sysConfig);
            })
            .catch(err => {
                closeFaceLogin(); 
                Swal.fire('‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤', err.message, 'error'); 
            });
         } catch (err) { closeFaceLogin(); Swal.fire('Error', err.message, 'error'); }
    } else {
        callAPI({ action: 'getEmployeeFaceData', empId: empId, deviceToken: getDeviceToken() }, function(res) {
            var currentInput = document.getElementById('loginInput').value;
            if (currentInput !== empId) {
                 closeFaceLogin();
                 return;
            }

            if (res.status === 'success') {
                try {
                    document.getElementById('faceStatus').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...';
                    prepareReferenceFace(res.image, res.name).then(() => {
                        startFaceCamera(empId, res.name, res.image, res.allowedApps, res.systemConfig);
                    });
                } catch (err) { closeFaceLogin(); Swal.fire('‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤', err.message, 'error'); }
            } else {
                closeFaceLogin();
                Swal.fire('‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', res.message, 'error');
            }
        });
    }
  }

  let faceModelsLoaded = false;
  let labeledFaceDescriptors = null;
  async function loadFaceModels() {
      const MODEL_URL = 'https://cdn.jsdelivr.net/gh/cgarciagl/face-api.js@0.22.2/weights/';
      try {
          await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
          await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
          await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
          faceModelsLoaded = true;
          var btn = document.getElementById('btnFaceLogin');
          btn.disabled = false; btn.innerHTML = '<i class="bi bi-person-bounding-box"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤';
      } catch (e) { var btn = document.getElementById('btnFaceLogin'); btn.innerHTML = '‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î AI ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; }
  }
  async function prepareReferenceFace(base64Image, name) {
    const img = await faceapi.fetchImage(base64Image);
    const detections = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
    if (!detections) throw new Error("‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏≤‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠");
    labeledFaceDescriptors = new faceapi.LabeledFaceDescriptors(name, [detections.descriptor]);
  }
  async function startFaceCamera(empId, empName, empPhoto, allowedApps, sysConfig) {
    const video = document.getElementById('faceVideo');
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
        video.srcObject = stream;
        video.onplay = () => {
            document.getElementById('faceStatus').innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á...';
            const canvas = document.getElementById('faceCanvas');
            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);
            const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.55);
            const interval = setInterval(async () => {
                if (!video.paused && !video.ended) {
                    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);
                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                    if (resizedDetections.length > 0) {
                        const bestMatch = faceMatcher.findBestMatch(resizedDetections[0].descriptor);
                        if (bestMatch.label !== 'unknown') {
                            clearInterval(interval); 
                            closeFaceLogin(); 
                            performLoginSuccess(empId, empName, empPhoto, allowedApps, sysConfig); 
                        }
                    }
                }
            }, 500);
            video.dataset.intervalId = interval;
        };
    } catch (err) { Swal.fire('Camera Error', err.message, 'error'); closeFaceLogin(); }
  }
  function closeFaceLogin() {
    const video = document.getElementById('faceVideo');
    if (video.srcObject) { video.srcObject.getTracks().forEach(t => t.stop()); }
    if (video.dataset.intervalId) clearInterval(video.dataset.intervalId);
    document.getElementById('faceLoginModal').classList.add('hidden');
  }

function performLoginSuccess(empId, name, photo, allowedApps, sysConfig) {
    // ‡πÅ‡∏™‡∏î‡∏á Loading ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

    var data = { 
        action: 'registerDevice', 
        empId: empId, 
        deviceToken: getDeviceToken(), 
        os: getMobileOS() 
    };

    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ callAPI ‡πÅ‡∏ö‡∏ö‡∏£‡∏≠‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    callAPI(data, function(res) {
        
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (Force Setup)
        if (res.status === 'force_setup') {
            Swal.close();
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
            document.getElementById('setupEmpId').value = res.empId;
            document.getElementById('setupShowName').innerText = res.name;
            document.getElementById('setupShowId').innerText = res.empId;
            
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Setup
            hideAll();
            document.getElementById('setupPassScreen').classList.remove('hidden');
            
            Swal.fire({ 
                icon: 'info', 
                title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö', 
                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ' 
            });
        } 
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥ (Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)
        else {
            Swal.fire({ 
                icon: 'success', 
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 
                text: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ' + name, 
                timer: 1500, 
                showConfirmButton: false 
            }).then(() => { 
                if (pendingBroadcastData.msg && pendingBroadcastData.msg.toString().trim() !== "") {
                    showBroadcast(pendingBroadcastData.msg, function() {
                        loginSuccess(empId, name, photo, allowedApps, sysConfig);
                        pendingBroadcastData = { msg: null, token: null, name: null, photo: null, allowedApps: null, sysConfig: null }; 
                    });
                } else {
                    loginSuccess(empId, name, photo, allowedApps, sysConfig);
                }
            });
        }
    });
}

  function showBroadcast(message, callback) {
      Swal.fire({
          title: 'üì¢ <strong>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</strong>',
          html: '<div style="text-align: left; font-size: 1rem;">' + message + '</div>',
          icon: 'info',
          confirmButtonText: '<i class="bi bi-check-lg"></i> ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö',
          confirmButtonColor: '#0d6efd',
          backdrop: `rgba(0,0,123,0.4)`,
          allowOutsideClick: false,
          allowEscapeKey: false
      }).then((result) => {
          if (result.isConfirmed) {
              if (callback) callback();
          }
      });
  }

  function doSubmitNewPassword() {
      var empId = document.getElementById('setupEmpId').value;
      var p1 = document.getElementById('newPass').value;
      var p2 = document.getElementById('confirmPass').value;

      if(!p1 || !p2) { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', 'warning'); return; }
      if(p1 !== p2) { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô', 'error'); return; }
      
      var data = { action: 'setPassword', empId: empId, newPass: p1, deviceToken: getDeviceToken(), os: getMobileOS() };
      callAPI(data, function(res) {
          if(res.status === 'success') {
              Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á' }).then((result) => { showLogin(); document.getElementById('loginInput').value = empId; document.getElementById('loginPass').value = ''; document.getElementById('loginPass').focus(); });
          } else { Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.message, 'error'); }
      });
  }
  function getLocalDateString() { var d = new Date(); var year = d.getFullYear(); var month = ('0' + (d.getMonth() + 1)).slice(-2); var day = ('0' + d.getDate()).slice(-2); return year + '-' + month + '-' + day; }
  function hideAll() { document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('registerScreen').classList.add('hidden'); document.getElementById('otpScreen').classList.add('hidden'); document.getElementById('dashboardScreen').classList.add('hidden'); document.getElementById('setupPassScreen').classList.add('hidden'); }
  function showLogin() { hideAll(); document.getElementById('loginScreen').classList.remove('hidden'); }
  function showRegister() { hideAll(); document.getElementById('registerScreen').classList.remove('hidden'); loadDepartments(); }
  function showOTP() { hideAll(); document.getElementById('otpScreen').classList.remove('hidden'); }
  function doLogout() { currentUser = null; if (watchId) navigator.geolocation.clearWatch(watchId); showLogin(); }
  
  function loadDepartments() { 
      callAPI({ action: 'getDepartments' }, function(res) { 
          if (res.status === 'success') { 
              var select = document.getElementById('regDept'); 
              select.innerHTML = '<option value="" selected disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>'; 
              res.data.forEach(function(dept) { 
                  var option = document.createElement('option'); option.value = dept; option.text = dept; select.appendChild(option); 
              }); 
          } 
      }); 
  }
  function validatePassword(pass) { return /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[\W_]).{8,}$/.test(pass); }
  function doRegister() { 
      var empId = document.getElementById('regEmpId').value; var fname = document.getElementById('regFname').value; var lname = document.getElementById('regLname').value; var dept = document.getElementById('regDept').value; var email = document.getElementById('regEmail').value; var pass = document.getElementById('regPass').value; var confirmPass = document.getElementById('regConfirmPass').value; 
      if (!empId || !fname || !lname || !dept || !email || !pass || !confirmPass) { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning'); return; } 
      if (pass !== confirmPass) { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô', 'error'); return; } 
      var data = { action: 'register', empId: empId, fname: fname, lname: lname, department: dept, email: email, password: pass }; tempEmail = data.email; 
      callAPI(data, function(res) { if(res.status === 'success') { Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', res.message, 'success'); showOTP(); } else { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', res.message, 'error'); } }); 
  }
  function doConfirmOTP() { callAPI({ action: 'confirmOTP', email: tempEmail, otp: document.getElementById('otpInput').value }, function(res) { if(res.status === 'success') { Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success'); showLogin(); } else { Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.message, 'error'); } }); }
  
  function openCamera() { 
      if (!isLocationValid) { return; } 
      if (lastScanTime) { var now = new Date(); var last = new Date(); var parts = lastScanTime.split(':'); last.setHours(parseInt(parts[0]), parseInt(parts[1]), parseInt(parts[2]), 0); var diffHrs = (now - last) / (1000 * 60 * 60); if (diffHrs < 2 && diffHrs >= 0) { var waitMins = Math.ceil((2 - diffHrs) * 60); Swal.fire({ icon: 'warning', title: '‡∏™‡πÅ‡∏Å‡∏ô‡∏ñ‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ', html: '‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á 2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á<br>‡∏£‡∏≠‡∏≠‡∏µ‡∏Å ' + waitMins + ' ‡∏ô‡∏≤‡∏ó‡∏µ' }); return; } } var modal = document.getElementById('cameraModal'); var video = document.getElementById('videoFeed'); modal.classList.remove('hidden'); modal.style.display = 'flex'; var constraints = { audio: false, video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } } }; navigator.mediaDevices.getUserMedia(constraints).then(function(stream) { video.srcObject = stream; }).catch(function(err) { Swal.fire('Camera Error', err.message, 'error'); closeCamera(); }); }
  function snapPhoto() { var video = document.getElementById('videoFeed'); if (!video.srcObject) return; Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } }); var canvas = document.createElement('canvas'); var ctx = canvas.getContext('2d'); var maxWidth = 800; var scale = maxWidth / video.videoWidth; canvas.width = maxWidth; canvas.height = video.videoHeight * scale; ctx.drawImage(video, 0, 0, canvas.width, canvas.height); var imageBase64 = canvas.toDataURL('image/jpeg', 0.8); closeCamera(); sendScanData(imageBase64); }
  function closeCamera() { var video = document.getElementById('videoFeed'); if (video.srcObject) { video.srcObject.getTracks().forEach(t => t.stop()); video.srcObject = null; } document.getElementById('cameraModal').style.display = 'none'; }
  function sendScanData(imageBase64) { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(function(position) { var data = { action: 'scan', empId: currentUser, clientDate: getLocalDateString(), lat: position.coords.latitude, lng: position.coords.longitude, imageBase64: imageBase64 }; callAPI(data, function(res) { Swal.close(); if(res.status === 'success') { Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏ß‡∏•‡∏≤: ' + res.time, 'success'); loadHistory(); } else { Swal.fire('Error', res.message, 'error'); } }); }, function(error) { Swal.fire('Location Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS', 'error'); }); } else { Swal.fire('Error', 'Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS', 'error'); } }


  // --- DASHBOARD LOGIC ---
  function loadStats() {
      var date = document.getElementById('statsDate').value;
      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
      
      // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å google.script.run ‡πÄ‡∏õ‡πá‡∏ô callAPI ***
      callAPI({ action: 'getStats', date: date }, function(res){
          Swal.close();
          if(res.status === 'success') { 
              renderDashboard(res.logs, res.totalStats); 
          } else { 
              Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', res.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'warning'); 
          }
      });
  }

  // --- USER MANAGEMENT LOGIC ---
  var userModal = null;
  var allUsersData = [];

  function loadUserList() {
      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
      callAPI({ action: 'getAllUsers' }, function(res){
          Swal.close();
          if(res.status === 'success') {
              allUsersData = res.data;
              updateDeptDropdown(allUsersData);
              renderUserTable(allUsersData);
          } else {
              Swal.fire('Error', res.message, 'error');
          }
      });
  }

  function renderUserTable(users) {
      var tbody = document.getElementById('userTableBody');
      tbody.innerHTML = '';
      if(users.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-5">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'; return; }
      users.forEach(u => {
          var tr = document.createElement('tr');
          var photoHtml = u.photoId ? `<img src="https://drive.google.com/thumbnail?id=${u.photoId}&sz=s100" class="rounded-circle border" style="width:38px; height:38px; object-fit:cover;">` : `<div class="rounded-circle bg-light border d-flex align-items-center justify-content-center" style="width:38px; height:38px;"><i class="bi bi-person text-secondary"></i></div>`;
          var statusBadge = (u.status === 'Active') ? '<span class="badge bg-success">‡∏õ‡∏Å‡∏ï‡∏¥</span>' : (u.status === 'Inactive') ? '<span class="badge bg-danger">‡∏≠‡∏≠‡∏Å</span>' : '<span class="badge bg-secondary">'+u.status+'</span>';
          tr.innerHTML = `<td class="text-center">${photoHtml}</td><td><div class="fw-bold text-dark" style="font-size: 0.9rem;">${u.fname} ${u.lname}</div><div class="d-flex align-items-center"><span class="badge bg-light text-dark border me-1">${u.empId}</span></div><div class="text-primary fst-italic small">${u.dept}</div></td><td class="text-center">${statusBadge}</td><td class="text-center"><button class="btn btn-sm btn-outline-secondary rounded-circle" onclick="openUserModal('edit', '${u.empId}')"><i class="bi bi-pencil-fill"></i></button></td>`;
          tbody.appendChild(tr);
      });
  }

  function filterUserTable() {
      var txt = document.getElementById('searchUser').value.toLowerCase().trim();
      var deptFilter = document.getElementById('filterDept').value; 

      var filtered = allUsersData.filter(u => {
          var matchText = (String(u.empId).toLowerCase().includes(txt) || String(u.fname).toLowerCase().includes(txt));
          var matchDept = (deptFilter === "" || u.dept === deptFilter);
          return matchText && matchDept;
      });
      renderUserTable(filtered);
  }

  function openUserModal(mode, empId) {
      if(!userModal) userModal = new bootstrap.Modal(document.getElementById('userFormModal'));
      document.getElementById('formMode').value = mode;
      
      document.getElementById('userForm').reset();
      document.getElementById('u_empId').readOnly = false;
      document.getElementById('editTools').classList.add('hidden'); 
      
      document.getElementById('u_photoFile').value = '';
      document.getElementById('u_currentPhotoId').value = '';
      document.getElementById('u_previewImg').classList.add('hidden');
      document.getElementById('u_noImageText').classList.remove('hidden');

      renderSystemCheckboxes([]);

      if(mode === 'add') {
          document.getElementById('userModalTitle').innerHTML = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
          document.getElementById('u_status').value = 'Active';
      } else {
          document.getElementById('userModalTitle').innerHTML = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
          document.getElementById('editTools').classList.remove('hidden');
          document.getElementById('u_empId').readOnly = true; 
          
          var u = allUsersData.find(x => String(x.empId) === String(empId));
          if(u) {
              document.getElementById('u_empId').value = u.empId;
              document.getElementById('u_fname').value = u.fname;
              document.getElementById('u_lname').value = u.lname;
              document.getElementById('u_email').value = u.email;
              document.getElementById('u_dept').value = u.dept;
              document.getElementById('u_status').value = u.status;
              if(u.startDate) { 
                  try {
                      var d = new Date(u.startDate);
                      var yyyy = d.getFullYear();
                      var mm = String(d.getMonth() + 1).padStart(2, '0');
                      var dd = String(d.getDate()).padStart(2, '0');
                      document.getElementById('u_startDate').value = `${yyyy}-${mm}-${dd}`;
                  } catch(e){}
              }

              if(u.photoId) {
                  document.getElementById('u_currentPhotoId').value = u.photoId;
                  document.getElementById('u_previewImg').src = "https://drive.google.com/thumbnail?id=" + u.photoId + "&sz=s200";
                  document.getElementById('u_previewImg').classList.remove('hidden');
                  document.getElementById('u_noImageText').classList.add('hidden');
              }

              var sysString = u.allowedSystems ? String(u.allowedSystems) : '';
              var userSystems = sysString.split(',').map(s => s.trim()); 
              
              renderSystemCheckboxes(userSystems);
          }
      }
      userModal.show();
  }

  function renderSystemCheckboxes(userSystems) {
      var container = document.getElementById('systemCheckboxContainer');
      container.innerHTML = '';
      
      systemConfigList.forEach(sys => {
          var isChecked = userSystems.includes(sys.id) || userSystems.includes('All') ? 'checked' : '';
          var html = `
              <div class="form-check">
                  <input class="form-check-input system-check" type="checkbox" value="${sys.id}" id="sys_${sys.id}" ${isChecked}>
                  <label class="form-check-label small" for="sys_${sys.id}">
                      ${sys.name}
                  </label>
              </div>
          `;
          container.innerHTML += html;
      });
  }

  function toggleAllSystems() {
      var isAll = document.getElementById('chk_AllSystems').checked;
      var checkboxes = document.querySelectorAll('.system-check');
      checkboxes.forEach(cb => cb.checked = isAll);
  }

  function previewImage(input) {
      if (input.files && input.files[0]) {
          var reader = new FileReader();
          reader.onload = function(e) {
              document.getElementById('u_previewImg').src = e.target.result;
              document.getElementById('u_previewImg').classList.remove('hidden');
              document.getElementById('u_noImageText').classList.add('hidden');
          }
          reader.readAsDataURL(input.files[0]);
      }
  }

  function saveUser() {
      var empId = document.getElementById('u_empId').value.trim();
      var fname = document.getElementById('u_fname').value.trim();
      var dept = document.getElementById('u_dept').value;
      if(!empId || !fname || !dept) { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning'); return; }

      var selectedSystems = [];
      if(document.getElementById('chk_AllSystems').checked) { selectedSystems.push('All'); } 
      else { document.querySelectorAll('.system-check:checked').forEach(cb => selectedSystems.push(cb.value)); }

      var userObj = {
          action: 'saveUser',
          mode: document.getElementById('formMode').value,
          empId: empId, fname: fname, lname: document.getElementById('u_lname').value.trim(),
          email: document.getElementById('u_email').value.trim(), dept: dept,
          status: document.getElementById('u_status').value,
          startDate: document.getElementById('u_startDate').value,
          currentPhotoId: document.getElementById('u_currentPhotoId').value,
          allowedSystems: selectedSystems.join(',')
      };

      var fileInput = document.getElementById('u_photoFile');
      if (fileInput.files.length > 0) {
          var reader = new FileReader();
          reader.onload = function(e) { userObj.fileData = e.target.result; sendSaveRequest(userObj); };
          reader.readAsDataURL(fileInput.files[0]);
      } else {
          userObj.fileData = ""; sendSaveRequest(userObj);
      }
  }

  function sendSaveRequest(data) {
      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() });
      callAPI(data, function(res){
          if(res.status==='success') { 
              Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1000, showConfirmButton: false });
              userModal.hide(); loadUserList(); 
          } else { Swal.fire('Error', res.message, 'error'); }
      });
  }

  function resetUserField(type) {
      var empId = document.getElementById('u_empId').value;
      Swal.fire({ title: (type === 'password') ? '‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?' : '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á?', icon: 'warning', showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' }).then((result) => {
          if (result.isConfirmed) {
              callAPI({ action: 'resetField', empId: empId, field: type }, function(res){
                  if(res.status === 'success') Swal.fire('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', res.message, 'success');
                  else Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.message, 'error');
              });
          }
      });
  }

  function updateDeptDropdown(users) {
      var depts = new Set();
      users.forEach(u => { if(u.dept) depts.add(u.dept); });
      var sorted = Array.from(depts).sort();

      var selModal = document.getElementById('u_dept');
      var currentVal = selModal.value; 
      selModal.innerHTML = '<option value="" selected disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>';
      sorted.forEach(d => { 
          var opt = document.createElement('option'); opt.text = d; opt.value = d; selModal.add(opt); 
      });
      if(currentVal) selModal.value = currentVal;

      var selFilter = document.getElementById('filterDept');
      var currentFilter = selFilter.value;
      selFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>';
      sorted.forEach(d => {
          var opt = document.createElement('option'); opt.text = d; opt.value = d; selFilter.add(opt);
      });
      selFilter.value = currentFilter;
  }
  
</script>

</body>
</html>